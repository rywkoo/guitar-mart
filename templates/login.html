{% extends "base.html" %}
{% block title %}Login - Mini Mart{% endblock %}

{% block content %}
<style>
  body {
    font-family: "DM Sans", sans-serif;
    background-color: #f9fafb;
    color: #1d1d1f;
  }

  .login-container {
    max-width: 400px;
    margin: 5rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    text-align: center;
  }

  .login-container h2 {
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #1d1d1f;
  }

  input {
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 1rem;
    transition: border 0.2s;
  }

  input:focus {
    outline: none;
    border-color: #4f46e5;
  }

  button {
    background-color: #4f46e5;
    color: #fff;
    border: none;
    padding: 0.75rem;
    border-radius: 50px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    font-size: 1rem;
    transition: all 0.2s;
    margin-top: 0.5rem;
  }

  button:hover {
    background-color: #4338ca;
    transform: translateY(-1px);
  }

  button:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  .msg {
    margin-top: 1rem;
    font-size: 0.95rem;
    min-height: 1.5rem;
  }

  .msg.success { color: #16a34a; }
  .msg.error { color: #dc2626; }

  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    text-align: center;
  }

  .modal-content h3 {
    margin-bottom: 1rem;
    color: #1d1d1f;
  }

  .register-link {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: #5f5f65;
  }

  .register-link a {
    color: #4f46e5;
    font-weight: 700;
    text-decoration: none;
  }

  .register-link a:hover {
    text-decoration: underline;
  }
</style>

<div class="login-container">
  <h2>Login</h2>
  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required autocomplete="username">
    <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
    <button type="submit" id="sendTokenBtn">Login</button>
    <div id="msg" class="msg"></div>
  </form>
  <div class="register-link">
    Don't have an account? <a href="/register-page">Register here</a>
  </div>
</div>

<!-- Token Modal -->
<div id="tokenModal" class="modal">
  <div class="modal-content">
    <h3>Enter Verification Code</h3>
    <p style="color:#5f5f65;font-size:0.9rem;margin-bottom:1rem;">
      Check your email for the 6-digit code
    </p>
    <input type="text" id="tokenInput" placeholder="000000" maxlength="6" required autocomplete="off">
    <button id="verifyBtn">Login</button>
    <div id="modalMsg" class="msg"></div>
  </div>
</div>

<script>
  // Elements
  const loginForm = document.getElementById("loginForm");
  const sendTokenBtn = document.getElementById("sendTokenBtn");
  const tokenModal = document.getElementById("tokenModal");
  const tokenInput = document.getElementById("tokenInput");
  const verifyBtn = document.getElementById("verifyBtn");
  const msg = document.getElementById("msg");
  const modalMsg = document.getElementById("modalMsg");

  let currentUsername = "";

  // Message helpers
  function setMsg(text, type = "error") {
    msg.textContent = text;
    msg.className = `msg ${type}`;
  }

  function setModalMsg(text, type = "error") {
    modalMsg.textContent = text;
    modalMsg.className = `msg ${type}`;
  }

  function disableBtn(btn, disabled = true) {
    btn.disabled = disabled;
    btn.style.opacity = disabled ? "0.6" : "1";
  }

  function openModal() {
    tokenModal.style.display = "flex";
    setTimeout(() => tokenInput.focus(), 100);
  }

  function closeModal() {
    tokenModal.style.display = "none";
    setModalMsg("");
    tokenInput.value = "";
  }

  // Step 1: Send login token
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
      setMsg("Please fill in all fields");
      return;
    }

    disableBtn(sendTokenBtn);
    setMsg("Sending Verification Code...", "");

    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();

      if (res.ok) {
        currentUsername = username;
        setMsg("Check your email for Verification Code!", "success");
        openModal();
      } else {
        setMsg(data.error || "Login failed");
      }
    } catch (err) {
      setMsg("Network error. Check internet.");
      console.error("Login error:", err);
    } finally {
      disableBtn(sendTokenBtn, false);
    }
  });

  // Step 2: Verify token
  verifyBtn.addEventListener("click", async () => {
    const token = tokenInput.value.trim();
    if (!token || token.length !== 6) {
      setModalMsg("Enter 6-digit code");
      return;
    }
    setModalMsg("Verifying...", "");
    try {
      const res = await fetch("/api/auth/login/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: currentUsername, token })
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem("jwtToken", data.access_token);
        localStorage.setItem("username", data.username);
        localStorage.setItem("role", data.role);  // SAVE ROLE
        setModalMsg("Login successful!", "success");
        setTimeout(() => {
          window.location.href = data.role === "admin" ? "/admin/dashboard" : "/";
        }, 1200);
      } else {
        setModalMsg(data.error || "Invalid token");
      }
    } catch (err) {
      setModalMsg("Network error");
    }
  });

  // Close modal on outside click
  window.addEventListener("click", (e) => {
    if (e.target === tokenModal) closeModal();
  });

  // Enter key in token input
  tokenInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") verifyBtn.click();
  });
</script>
{% endblock %}