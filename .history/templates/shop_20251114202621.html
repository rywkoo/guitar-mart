{% extends "base.html" %}
{% block title %}Shop{% endblock %}

{% block content %}
<div style="display:flex; gap:1rem; padding:2rem; flex-wrap:wrap;">

  <!-- Sidebar -->
  <aside id="sidebar" style="width:250px; position:sticky; top:calc(var(--navbar-height) + 1rem); border:1px solid var(--color-border); padding:1rem; border-radius:var(--radius-md); background:var(--color-bg); height:max-content;">
    <h2 style="font-size:1.25rem; margin-bottom:1rem; font-weight:600;">Filter Products</h2>
    
    <input type="text" id="searchInput" placeholder="Search name or category..." 
           style="width:100%; padding:.5rem; margin-bottom:1rem; border:1px solid var(--color-border); border-radius:var(--radius-sm);">

    <label style="display:block; margin-bottom:.25rem;">Max Price: <span id="priceValue"></span></label>
    <input type="range" id="priceSlider" min="0" max="5000" step="1" value="5000" style="width:100%; margin-bottom:1rem;">

    <div id="categoryFilters" style="margin-bottom:1rem;">
      <strong>Categories:</strong><br>
    </div>
  </aside>

  <!-- Product Grid -->
  <div id="productGrid" style="flex:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem;">
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
/* ============================================================
   NEW BEAUTIFUL SUCCESS MODAL
   ============================================================ */

const modal = document.createElement("div");
modal.id = "shopModal";
Object.assign(modal.style, {
  position: "fixed",
  inset: 0,
  display: "none",
  justifyContent: "center",
  alignItems: "center",
  background: "rgba(0,0,0,0.55)",
  backdropFilter: "blur(3px)",
  zIndex: "9999",
  opacity: "0",
  transition: "opacity .25s ease"
});
document.body.appendChild(modal);

const modalBox = document.createElement("div");
Object.assign(modalBox.style, {
  width: "340px",
  background: "white",
  padding: "2rem 1.5rem",
  borderRadius: "20px",
  textAlign: "center",
  transform: "scale(.85)",
  transition: "transform .25s ease"
});
modal.appendChild(modalBox);

// Big check icon
modalBox.innerHTML = `
  <div style="font-size:70px; color:#4fbd4f; margin-bottom:10px;">✔</div>
  <h2 style="font-size:1.4rem; font-weight:700; margin-bottom:8px;">Product Added!</h2>
  <p id="shopModalMessage" style="margin:0 0 20px; font-size:.95rem; color:#555;">
    Your item has been added to the cart.
  </p>
  <div style="display:flex; gap:12px; justify-content:center;">
    <button id="continueShoppingBtn"
      style="padding:.55rem 1rem; background:#e9ecef; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
      Continue Shopping
    </button>
    <button id="goToCartBtn"
      style="padding:.55rem 1rem; background:var(--color-primary); color:white; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
      Go to Cart
    </button>
  </div>
`;

function showModal(message) {
  document.getElementById("shopModalMessage").textContent = message;

  modal.style.display = "flex";
  requestAnimationFrame(() => {
    modal.style.opacity = "1";
    modalBox.style.transform = "scale(1)";
  });

  modal.onclick = (e) => {
    if (e.target === modal) closeModal();
  };
}

function closeModal() {
  modal.style.opacity = "0";
  modalBox.style.transform = "scale(.85)";
  setTimeout(() => modal.style.display = "none", 250);
}

document.getElementById("continueShoppingBtn").onclick = closeModal;
document.getElementById("goToCartBtn").onclick = () => window.location.href = "/cart";



/* ============================================================
   CART FUNCTIONS (old working logic)
   ============================================================ */

function getCart() {
  return JSON.parse(localStorage.getItem("cart") || "[]");
}

function saveCart(cart) {
  localStorage.setItem("cart", JSON.stringify(cart));
  if (window.updateCartCount) window.updateCartCount();
}

function addToCart(product) {
  const cart = getCart();
  const existing = cart.find(i => i.id === product.id);

  if (existing) existing.quantity += 1;
  else cart.push({ ...product, quantity: 1 });

  saveCart(cart);

  showModal(`"${product.name}" added to cart!`);
}



/* ============================================================
   PRODUCT FETCH + RENDER (old logic, fixed image path)
   ============================================================ */

let allProducts = [];
let allCategories = [];

async function fetchProducts() {
  const res = await fetch("/api/products");
  allProducts = await res.json();

  renderCategories();
  renderProducts();

  if (window.updateCartCount) window.updateCartCount();
}

function renderCategories() {
  const container = document.getElementById("categoryFilters");
  const categoryMap = {};

  allProducts.forEach(p => {
    if (p.category_id && !categoryMap[p.category_id]) {
      categoryMap[p.category_id] = p.category_name;
    }
  });

  allCategories = Object.entries(categoryMap);

  container.innerHTML = "<strong>Categories:</strong><br>";

  allCategories.forEach(([id, name]) => {
    container.innerHTML += `
      <label style="display:block; margin-bottom:.25rem;">
        <input type="checkbox" value="${id}" class="categoryCheckbox" checked>
        ${name}
      </label>
    `;
  });
}

function renderProducts() {
  const grid = document.getElementById("productGrid");
  const searchQuery = document.getElementById("searchInput").value.toLowerCase();
  const maxPrice = parseFloat(document.getElementById("priceSlider").value);
  const checkedCategories = Array.from(document.querySelectorAll(".categoryCheckbox:checked"))
                                .map(c => parseInt(c.value));

  grid.innerHTML = "";

  allProducts.forEach(p => {
    const matchesSearch =
      p.name.toLowerCase().includes(searchQuery) ||
      (p.category_name && p.category_name.toLowerCase().includes(searchQuery));

    const matchesPrice = p.price <= maxPrice;
    const matchesCategory = checkedCategories.includes(p.category_id);

    if (matchesSearch && matchesPrice && matchesCategory) {

      // ✅ FIXED IMAGE LOGIC (uses your old working path)
      const imgSrc = p.image
        ? `/static/uploads/${p.image}`
        : "https://via.placeholder.com/220x180?text=No+Image";

      grid.innerHTML += `
        <div style="border:1px solid var(--color-border); border-radius:var(--radius-md); overflow:hidden; background:var(--color-bg); display:flex; flex-direction:column;">
          <div style="height:180px; overflow:hidden;">
            <img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover;">
          </div>

          <div style="padding:.75rem 1rem; flex:1; display:flex; flex-direction:column;">
            <h3 style="font-size:1rem; margin:0 0 .25rem; font-weight:600;">${p.name}</h3>
            <p style="margin:0 0 .25rem; font-weight:700; color:var(--color-primary)">$${p.price.toFixed(2)}</p>
            <p style="margin:0 0 .25rem; font-size:.85rem; color:var(--color-text-muted)">${p.category_name || "No category"}</p>

            <button class="addToCartBtn" data-product='${JSON.stringify(p)}'
              style="margin-top:auto; padding:.5rem; background:var(--color-primary); color:white; border:none; border-radius:var(--radius-sm); cursor:pointer;">
              Add to Cart
            </button>
          </div>
        </div>
      `;
    }
  });
}

// Add to cart event
document.addEventListener("click", e => {
  if (e.target.classList.contains("addToCartBtn")) {
    const product = JSON.parse(e.target.getAttribute("data-product"));
    addToCart(product);
  }
});



/* ============================================================
   FILTER EVENTS + INIT
   ============================================================ */

document.getElementById("searchInput").addEventListener("input", renderProducts);

document.getElementById("priceSlider").addEventListener("input", () => {
  document.getElementById("priceValue").textContent =
    "$" + document.getElementById("priceSlider").value;
  renderProducts();
});

document.addEventListener("change", e => {
  if (e.target.classList.contains("categoryCheckbox")) renderProducts();
});

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("priceValue").textContent =
    "$" + document.getElementById("priceSlider").value;
  fetchProducts();
});
</script>
{% endblock %}
