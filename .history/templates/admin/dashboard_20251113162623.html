{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Dashboard</h1>
<p class="text-muted">Welcome, <span id="adminUsername">Admin</span>. Manage your store and view analytics here.</p>

<div id="dashboardGrid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
    gap:1.5rem;
    margin-top:1rem;
">
  <!-- Stats Cards Loaded via JS -->
</div>

<!-- ---------- MAIN CHART ---------- -->
<div style="margin-top:2rem; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05);">
  <h2 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">All Purchases</h2>
  <div style="margin-bottom:1rem;">
    <select id="mainReportType" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="alltime">All Time</option>
    </select>
  </div>
  <canvas id="mainPurchaseChart" style="width:100%;max-height:400px;"></canvas>
</div>

<!-- ---------- USER CHART + INVOICE LIST ---------- -->
<div style="display:flex; gap:2rem; margin-top:2rem;">
  
  <!-- Invoice list on the left -->
  <div style="flex:1; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05); max-height:400px; overflow-y:auto;">
    <h3 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Invoices (Last 7 Days)</h3>
    <input type="text" id="invoiceSearch" placeholder="Search username or invoice #" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;margin-bottom:.5rem;width:100%;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Invoice #</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Username</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:right;">Total ($)</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Date</th>
        </tr>
      </thead>
      <tbody id="invoiceTableBody"></tbody>
    </table>
  </div>

  <!-- User chart on the right -->
  <div style="flex:1; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05);">
    <h3 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">User Purchases</h3>
    <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
      <input type="text" id="userSearch" placeholder="Search username..." style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <select id="userReportType" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="alltime">All Time</option>
      </select>
    </div>
    <canvas id="userPurchaseChart" style="width:100%;max-height:300px;"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let mainChart = null;
let userChart = null;
let allInvoices = [];

// ----------------------
// Load dashboard stats & invoices
// ----------------------
async function loadCounts() {
  try {
    const headers = { "Accept": "application/json" };
    const [products, categories, invoices] = await Promise.all([
      fetch("/admin/api/products", { headers }).then(r => r.json()),
      fetch("/admin/api/categories", { headers }).then(r => r.json()),
      fetch("/admin/api/invoices", { headers }).then(r => r.json())
    ]);
    allInvoices = invoices;

    const grid = document.getElementById("dashboardGrid");
    grid.innerHTML = `
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Products</div>
        <h2 style="margin-top:.5rem;color:#4f46e5;">${products.length}</h2>
        <small class="text-muted">Active items</small>
      </div>
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Categories</div>
        <h2 style="margin-top:.5rem;color:#16a34a;">${categories.length}</h2>
        <small class="text-muted">Product groupings</small>
      </div>
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Invoices</div>
        <h2 style="margin-top:.5rem;color:#0ea5e9;">${invoices.length}</h2>
        <small class="text-muted">All purchases</small>
      </div>
    `;

    loadMainChart();
    loadUserChart();
    loadInvoiceTable();
  } catch (err) {
    console.error(err);
  }
}

// ----------------------
// Filter invoices
// ----------------------
function filterInvoicesByTime(invoices, type) {
  const today = new Date();
  if (type==='alltime') return invoices;
  return invoices.filter(inv => {
    const invDate = new Date(inv.created_at);
    if (type==='daily') return invDate.toDateString() === today.toDateString();
    if (type==='weekly') { const weekAgo = new Date(today); weekAgo.setDate(today.getDate()-6); return invDate>=weekAgo; }
    if (type==='monthly') { const monthAgo = new Date(today); monthAgo.setMonth(today.getMonth()-1); return invDate>=monthAgo; }
    return true;
  });
}

// ----------------------
// Main Chart
// ----------------------
function loadMainChart() {
  const type = document.getElementById("mainReportType").value;
  const filtered = filterInvoicesByTime(allInvoices, type);

  const dateMap = {};
  filtered.forEach(inv => {
    const date = inv.created_at.split("T")[0];
    if (!dateMap[date]) dateMap[date] = 0;
    dateMap[date] += inv.total_amount;
  });

  const labels = Object.keys(dateMap).sort();
  const totals = Object.values(dateMap);

  const ctx = document.getElementById("mainPurchaseChart").getContext("2d");
  if(mainChart) mainChart.destroy();
  mainChart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{ label:'Total Purchases', data:totals, borderColor:'#4f46e5', backgroundColor:'rgba(79,70,229,0.2)', fill:true, tension:0.3, pointRadius:4 }]},
    options:{ responsive:true, plugins:{ legend:{ display:true, position:'top' }, tooltip:{ mode:'index', intersect:false } }, scales:{ y:{ beginAtZero:true }, x:{ ticks:{ maxRotation:0 } } } }
  });
}

// ----------------------
// User Chart
// ----------------------
function loadUserChart() {
  const username = document.getElementById("userSearch").value.trim();
  const type = document.getElementById("userReportType").value;
  if(!username){ if(userChart) userChart.destroy(); return; }

  let filtered = allInvoices.filter(inv=>inv.username===username);
  filtered = filterInvoicesByTime(filtered,type);

  const dataPoints = filtered.map(inv=>({x:new Date(inv.created_at), y:inv.total_amount}));

  const ctx = document.getElementById("userPurchaseChart").getContext("2d");
  if(userChart) userChart.destroy();
  userChart = new Chart(ctx,{
    type:'scatter',
    data:{ datasets:[{ label:`Purchases of ${username}`, data:dataPoints, backgroundColor:'#16a34a' }]},
    options:{ responsive:true, scales:{ x:{ type:'time', time:{ unit:'day' } }, y:{ beginAtZero:true } }, plugins:{ legend:{ display:true } } }
  });
}

// ----------------------
// Invoice Table
// ----------------------
function loadInvoiceTable() {
  const search = document.getElementById("invoiceSearch").value.toLowerCase();
  const tbody = document.getElementById("invoiceTableBody");
  tbody.innerHTML = "";

  const last7Days = new Date(); last7Days.setDate(last7Days.getDate()-6);
  allInvoices.filter(inv=>new Date(inv.created_at)>=last7Days)
             .filter(inv => inv.username.toLowerCase().includes(search) || inv.invoice_number.toLowerCase().includes(search))
             .sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
             .forEach(inv=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.invoice_number}</td>
                    <td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.username}</td>
                    <td style="padding:.5rem;border-bottom:1px solid #ccc;text-align:right;">${inv.total_amount}</td>
                    <td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.created_at.split("T")[0]}</td>`;
    tbody.appendChild(tr);
  });
}

// ----------------------
// Event listeners
// ----------------------
document.getElementById("mainReportType").addEventListener("change", loadMainChart);
document.getElementById("userSearch").addEventListener("input", loadUserChart);
document.getElementById("userReportType").addEventListener("change", loadUserChart);
document.getElementById("invoiceSearch").addEventListener("input", loadInvoiceTable);

// ----------------------
// Initial load
// ----------------------
document.getElementById("adminUsername").textContent = "Admin";
loadCounts();
</script>
{% endblock %}
