{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Dashboard</h1>
<p class="text-muted">Welcome, <span id="adminUsername">Admin</span>. Manage your store and view analytics here.</p>

<div id="dashboardGrid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
    gap:1.5rem;
    margin-top:1rem;
">
  <!-- Stats Cards Loaded via JS -->
</div>

<!-- ---------- MAIN CHART ---------- -->
<div style="margin-top:2rem; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05);">
  <h2 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">All Purchases</h2>

  <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
    <select id="mainReportType" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="alltime">All Time</option>
    </select>
    <input type="text" id="mainUserSearch" placeholder="Filter by username..." style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
    <input type="text" id="mainInvoiceSearch" placeholder="Filter by invoice #" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
  </div>

  <canvas id="mainPurchaseChart" style="width:100%;max-height:400px;"></canvas>
</div>

<!-- ---------- USER CHART ---------- -->
<div style="margin-top:2rem; display:flex; gap:2rem;">
  <div style="flex:1; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05);">
    <h3 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">User Purchases</h3>
    <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
      <input type="text" id="userSearch" placeholder="Search username..." style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <select id="userReportType" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="alltime">All Time</option>
      </select>
    </div>
    <canvas id="userPurchaseChart" style="width:100%;max-height:300px;"></canvas>
  </div>

  <!-- INVOICE TABLE -->
  <div style="flex:1; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05); max-height:400px; overflow-y:auto;">
    <h3 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Invoices (Last 7 Days)</h3>
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Invoice #</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Username</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:right;">Total ($)</th>
          <th style="border-bottom:1px solid #ccc;padding:.5rem;text-align:left;">Date</th>
        </tr>
      </thead>
      <tbody id="invoiceTableBody"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let mainChart = null;
let userChart = null;
let allInvoices = [];

// ----------------------
// Load dashboard stats
// ----------------------
async function loadCounts() {
  try {
    const headers = { "Accept": "application/json" };
    const [products, categories, invoices] = await Promise.all([
      fetch("/admin/api/products", { headers }).then(r => r.json()),
      fetch("/admin/api/categories", { headers }).then(r => r.json()),
      fetch("/admin/api/invoices", { headers }).then(r => r.json())
    ]);
    allInvoices = invoices;

    // Load stats cards
    const grid = document.getElementById("dashboardGrid");
    grid.innerHTML = `
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Products</div>
        <h2 style="margin-top:.5rem;color:#4f46e5;">${products.length}</h2>
        <small class="text-muted">Active items</small>
      </div>
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Categories</div>
        <h2 style="margin-top:.5rem;color:#16a34a;">${categories.length}</h2>
        <small class="text-muted">Product groupings</small>
      </div>
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Invoices</div>
        <h2 style="margin-top:.5rem;color:#0ea5e9;">${invoices.length}</h2>
        <small class="text-muted">All purchases</small>
      </div>
    `;
  } catch (err) {
    console.error(err);
  }
}

// ----------------------
// Filter functions
// ----------------------
function filterInvoicesForMain(type, usernameFilter="", invoiceFilter="") {
  const today = new Date();
  const filtered = allInvoices.filter(inv => {
    const invDate = new Date(inv.created_at);
    if (type === "daily" && invDate.toDateString() !== today.toDateString()) return false;
    if (type === "weekly") {
      const weekAgo = new Date(today); weekAgo.setDate(today.getDate()-6);
      if (invDate < weekAgo) return false;
    }
    if (type === "monthly") {
      const monthAgo = new Date(today); monthAgo.setMonth(today.getMonth()-1);
      if (invDate < monthAgo) return false;
    }
    if (usernameFilter && !inv.username.toLowerCase().includes(usernameFilter.toLowerCase())) return false;
    if (invoiceFilter && !inv.invoice_number.toLowerCase().includes(invoiceFilter.toLowerCase())) return false;
    return true;
  });
  return filtered;
}

function filterInvoicesForUser(username, type) {
  let filtered = allInvoices.filter(inv => inv.username === username);
  const today = new Date();
  if (type === "daily") filtered = filtered.filter(inv => new Date(inv.created_at).toDateString() === today.toDateString());
  if (type === "weekly") {
    const weekAgo = new Date(today); weekAgo.setDate(today.getDate()-6);
    filtered = filtered.filter(inv => new Date(inv.created_at) >= weekAgo);
  }
  if (type === "monthly") {
    const monthAgo = new Date(today); monthAgo.setMonth(today.getMonth()-1);
    filtered = filtered.filter(inv => new Date(inv.created_at) >= monthAgo);
  }
  return filtered;
}

// ----------------------
// Load charts
// ----------------------
function loadMainChart() {
  const type = document.getElementById("mainReportType").value;
  const usernameFilter = document.getElementById("mainUserSearch").value;
  const invoiceFilter = document.getElementById("mainInvoiceSearch").value;

  const filtered = filterInvoicesForMain(type, usernameFilter, invoiceFilter);

  // Aggregate totals per day
  const dateMap = {};
  filtered.forEach(inv => {
    const date = inv.created_at.split("T")[0];
    if (!dateMap[date]) dateMap[date] = 0;
    dateMap[date] += inv.total_amount;
  });

  const labels = Object.keys(dateMap).sort();
  const totals = Object.values(dateMap);

  const ctx = document.getElementById("mainPurchaseChart").getContext("2d");
  if (mainChart) mainChart.destroy();
  mainChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{
      label:"Total Purchases",
      data:totals,
      borderColor:'#4f46e5',
      backgroundColor:'rgba(79,70,229,0.2)',
      fill:true,
      tension:0.3,
      pointRadius:3
    }]},
    options:{ responsive:true }
  });

  // Populate table with last 7 days
  const tbody = document.getElementById("invoiceTableBody");
  tbody.innerHTML = "";
  filtered.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
          .slice(0,50)
          .forEach(inv=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `<td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.invoice_number}</td>
                            <td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.username}</td>
                            <td style="padding:.5rem;border-bottom:1px solid #ccc;text-align:right;">${inv.total_amount}</td>
                            <td style="padding:.5rem;border-bottom:1px solid #ccc;">${inv.created_at.split("T")[0]}</td>`;
            tbody.appendChild(tr);
          });
}

function loadUserChart() {
  const username = document.getElementById("userSearch").value;
  const type = document.getElementById("userReportType").value;
  if (!username) { if(userChart) userChart.destroy(); return; }

  const filtered = filterInvoicesForUser(username, type);
  const labels = filtered.map(inv=>inv.created_at.split("T")[0]);
  const totals = filtered.map(inv=>inv.total_amount);

  const ctx = document.getElementById("userPurchaseChart").getContext("2d");
  if (userChart) userChart.destroy();
  userChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{
      label:`Purchases of ${username}`,
      data:totals,
      borderColor:'#16a34a',
      backgroundColor:'rgba(22,163,52,0.2)',
      fill:true,
      tension:0.3,
      pointRadius:3
    }]},
    options:{ responsive:true }
  });
}

// ----------------------
// Event listeners
// ----------------------
document.getElementById("mainReportType").addEventListener("change", loadMainChart);
document.getElementById("mainUserSearch").addEventListener("input", loadMainChart);
document.getElementById("mainInvoiceSearch").addEventListener("input", loadMainChart);

document.getElementById("userSearch").addEventListener("input", loadUserChart);
document.getElementById("userReportType").addEventListener("change", loadUserChart);

// ----------------------
// Initial load
// ----------------------
document.getElementById("adminUsername").textContent = "Admin";
loadCounts().then(()=>{
  loadMainChart();
  loadUserChart();
});
</script>

<style>
#dashboardGrid > div:hover {
  box-shadow:0 8px 20px rgba(0,0,0,.1);
  transform: translateY(-4px);
  transition:all .2s;
}
</style>
{% endblock %}
