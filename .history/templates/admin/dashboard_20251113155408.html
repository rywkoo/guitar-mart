{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let purchaseChart = null;
let allUsers = []; // store all usernames for search suggestions

// ----------------------
// Load dashboard stats
// ----------------------
async function loadCounts() {
  try {
    const headers = { "Accept": "application/json" };

    const [products, categories, users] = await Promise.all([
      fetch("/admin/api/products", { headers }).then(r => r.json()),
      fetch("/admin/api/categories", { headers }).then(r => r.json()),
      fetch("/admin/api/users", { headers }).then(r => r.json())
    ]);

    allUsers = users.map(u => u.username);

    const usernameSelect = document.getElementById("usernameFilter");
    usernameSelect.innerHTML = '<option value="">All Users</option>';
    allUsers.forEach(u => {
      const option = document.createElement("option");
      option.value = u;
      option.textContent = u;
      usernameSelect.appendChild(option);
    });

    const grid = document.getElementById("dashboardGrid");
    grid.innerHTML = `
      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.05);transition:all .2s;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Products</div>
        <h2 style="margin-top:.5rem;color:#4f46e5;">${products.length}</h2>
        <small class="text-muted">Active items in catalog</small>
      </div>

      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.05);transition:all .2s;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Categories</div>
        <h2 style="margin-top:.5rem;color:#16a34a;">${categories.length}</h2>
        <small class="text-muted">Product groupings</small>
      </div>

      <div style="background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e9ecef;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.05);transition:all .2s;">
        <div style="font-weight:700;font-size:1.1rem;color:#1d1d1f;">Total Users</div>
        <h2 style="margin-top:.5rem;color:#0ea5e9;">${users.length}</h2>
        <small class="text-muted">Registered accounts</small>
      </div>
    `;

    Array.from(grid.children).forEach(card => {
      card.onmouseover = () => card.style.transform = 'translateY(-4px)';
      card.onmouseout = () => card.style.transform = 'translateY(0)';
    });

  } catch (err) {
    console.error(err);
  }
}

// ----------------------
// Load purchase report / timeline
// ----------------------
async function loadPurchaseReport(usernameParam) {
  try {
    const type = document.getElementById("reportType").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    const username = usernameParam !== undefined
      ? usernameParam
      : document.getElementById("usernameFilter").value;

    const params = new URLSearchParams({ type });
    if (username) params.append("username", username);
    if (type === "custom") {
      if (!startDate || !endDate) return;
      params.append("start", startDate);
      params.append("end", endDate);
    }

    const res = await fetch("/admin/api/reports/purchases?" + params.toString());
    if (!res.ok) throw new Error("Failed to load report");
    const data = await res.json();

    // If searching for a user, show **timeline of all invoices**
    let labels = [];
    let totals = [];
    if (username) {
      // Sort invoices by date ascending
      const sortedInvoices = data.invoices.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
      labels = sortedInvoices.map(inv => inv.created_at.split('T')[0]); // date only
      totals = sortedInvoices.map(inv => inv.total_amount);
    } else {
      labels = data.labels;
      totals = data.totals;
    }

    const ctx = document.getElementById("purchaseChart").getContext("2d");
    if (purchaseChart) purchaseChart.destroy();

    purchaseChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: username ? `Timeline of ${username}` : 'Total Purchases ($)',
          data: totals,
          backgroundColor: 'rgba(79,70,229,0.2)',
          borderColor: '#4f46e5',
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 3, // smaller dots
          pointBackgroundColor: '#4f46e5'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 0 } }
        }
      }
    });

  } catch (err) {
    console.error(err);
  }
}

// ----------------------
// Event listeners
// ----------------------
document.getElementById("reportType").addEventListener("change", () => {
  const type = document.getElementById("reportType").value;
  if (type === "custom") {
    document.getElementById("startDate").style.display = "inline-block";
    document.getElementById("endDate").style.display = "inline-block";
  } else {
    document.getElementById("startDate").style.display = "none";
    document.getElementById("endDate").style.display = "none";
  }
  loadPurchaseReport();
});

document.getElementById("usernameFilter").addEventListener("change", () => loadPurchaseReport());
document.getElementById("startDate").addEventListener("change", () => loadPurchaseReport());
document.getElementById("endDate").addEventListener("change", () => loadPurchaseReport());

// User search autocomplete + timeline
document.getElementById("userSearch").addEventListener("input", function() {
  const value = this.value.toLowerCase();
  const usernameSelect = document.getElementById("usernameFilter");
  usernameSelect.innerHTML = '<option value="">All Users</option>';

  allUsers.filter(u => u.toLowerCase().includes(value))
          .forEach(u => {
            const option = document.createElement("option");
            option.value = u;
            option.textContent = u;
            usernameSelect.appendChild(option);
          });

  loadPurchaseReport(this.value || "");
});

// ----------------------
// Initial load
// ----------------------
document.getElementById("adminUsername").textContent = "Admin";
loadCounts();
loadPurchaseReport();
</script>
{% endblock %}
