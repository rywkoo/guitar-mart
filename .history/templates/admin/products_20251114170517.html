{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1.5rem;">Products</h1>

<button id="addProductBtn" style="
    background:#4f46e5;color:#fff;font-weight:700;
    padding:.5rem 1.25rem;border:none;border-radius:12px;
    cursor:pointer;margin-bottom:1rem;transition:all .2s;">
    Add Product
</button>

<!-- SEARCH BAR -->
<div style="margin-bottom:1rem;">
  <input type="text" id="productSearch" placeholder="Search products by name..." 
         style="width:100%;max-width:400px;padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;font-size:0.9rem;">
</div>

<table style="width:100%;border-collapse:collapse;text-align:left;
             box-shadow:0 4px 10px rgba(0,0,0,.05);border-radius:8px;overflow:hidden;">
  <thead>
    <tr style="background:#f8f9fa;">
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">ID</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Name</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Price</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Stock</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Category</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Image</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Actions</th>
    </tr>
  </thead>
  <tbody id="productTableBody">
    {% for p in products %}
    <tr data-id="{{ p.id }}" style="border-bottom:1px solid #e9ecef;vertical-align:middle;">
      <td style="padding:10px;">{{ p.id }}</td>
      <td style="padding:10px;">{{ p.name }}</td>
      <td style="padding:10px;">${{ "%.2f"|format(p.price) }}</td>
      <td style="padding:10px;">{{ p.stock }}</td>
      <td style="padding:10px;">{{ p.category.name if p.category else 'N/A' }}</td>
      <td style="padding:10px;">
        {% if p.image %}
        <img src="{{ url_for('static', filename='images/' ~ p.image) }}"
             alt="{{ p.name }}"
             style="max-width:80px;max-height:80px;object-fit:cover;
                    border-radius:8px;display:block;margin:auto;
                    border:1px solid #e9ecef;padding:2px;">
        {% else %}N/A{% endif %}
      </td>
      <td style="padding:10px;">
        <button class="edit-btn" onclick="openEditModal({{ p.id }})"
                style="margin-right:5px;background:#4f46e5;color:#fff;
                       padding:.35rem .75rem;border:none;border-radius:8px;
                       cursor:pointer;transition:all .2s;">Edit</button>
        <button class="delete-btn" 
                onclick="openDeleteModal({{ p.id }}, {{ p.name|tojson }})"
                style="background:#ff4757;color:#fff;padding:.35rem .75rem;
                       border:none;border-radius:8px;cursor:pointer;transition:all .2s;">
          Delete
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- MODALS (Add/Edit/Delete) -->
{% include 'admin/modals/product_modals.html' %}
{% endblock %}

{% block scripts %}
<script>
/* ---------- MODAL ELEMENTS ---------- */
const addModal = document.getElementById('addProductModal');
const editModal = document.getElementById('editProductModal');
const deleteModal = document.getElementById('deleteConfirmModal');
const closeAdd = document.getElementById('closeAddModal');
const closeEdit = document.getElementById('closeEditModal');

/* ---------- OPEN ADD MODAL ---------- */
document.getElementById('addProductBtn').onclick = () => {
  addModal.style.display = 'flex';
  document.getElementById('addResponse').innerHTML = '';
  document.getElementById('productForm').reset();
};

/* ---------- CLOSE MODALS ---------- */
closeAdd.onclick = () => {
  addModal.style.display = 'none';
  document.getElementById('productForm').reset();
};
closeEdit.onclick = () => {
  editModal.style.display = 'none';
  document.getElementById('editProductForm').reset();
};

window.onclick = e => {
  if (e.target === addModal) addModal.style.display = 'none';
  if (e.target === editModal) editModal.style.display = 'none';
  if (e.target === deleteModal) deleteModal.style.display = 'none';
};

/* ---------- SEARCH BAR ---------- */
document.getElementById('productSearch').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('#productTableBody tr').forEach(row => {
    const name = row.children[1].textContent.toLowerCase();
    row.style.display = name.includes(query) ? '' : 'none';
  });
});

/* ---------- OPEN EDIT MODAL ---------- */
async function openEditModal(id) {
  const token = localStorage.getItem('jwtToken');
  if (!token) return alert('Please log in again');

  const res = await fetch(`/admin/api/products/${id}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  if (!res.ok) return alert('Failed to load product');

  const data = await res.json();

  document.getElementById('editProductId').value = data.id;
  document.getElementById('editName').value = data.name;
  document.getElementById('editPrice').value = data.price;
  document.getElementById('editStock').value = data.stock;
  document.getElementById('editCategory').value = data.category_id || '';

  editModal.style.display = 'flex';
}

/* ---------- ADD PRODUCT ---------- */
document.getElementById('productForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const token = localStorage.getItem('jwtToken');
  if (!token) return alert('JWT missing');

  const res = await fetch('/admin/api/products', {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` },
    body: formData
  });

  const json = await res.json();
  const resp = document.getElementById('addResponse');

  if (res.ok) {
    resp.innerHTML = '<span style="color:green">Product added! Reloading...</span>';
    setTimeout(() => location.reload(), 1000);
  } else {
    resp.innerHTML = `<span style="color:red">${json.error || 'Failed'}</span>`;
  }
});

/* ---------- EDIT PRODUCT ---------- */
document.getElementById('editProductForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const id = formData.get('product_id');
  const token = localStorage.getItem('jwtToken');
  if (!token) return alert('JWT missing');

  const res = await fetch(`/admin/api/products/${id}`, {
    method: 'PATCH',
    headers: { Authorization: `Bearer ${token}` },
    body: formData
  });

  const json = await res.json();
  if (res.ok) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (row) {
      row.children[1].textContent = json.product.name;
      row.children[2].textContent = '$' + Number(json.product.price).toFixed(2);
      row.children[3].textContent = json.product.stock;
      row.children[4].textContent = json.product.category_name || 'N/A';
      if (json.product.image) {
        row.children[5].innerHTML = `<img src="/static/images/${json.product.image}" style="max-width:80px;max-height:80px;object-fit:cover;border-radius:8px;display:block;margin:auto;border:1px solid #e9ecef;padding:2px;">`;
      }
    }
    e.target.reset();
    editModal.style.display = 'none';
  } else {
    alert(json.error || 'Update failed');
  }
});

/* ---------- DELETE PRODUCT ---------- */
let productToDelete = null;

function openDeleteModal(id, name) {
  productToDelete = id;
  document.getElementById('deleteProductName').textContent = name;
  deleteModal.style.display = 'flex';
}

document.getElementById('cancelDeleteBtn').onclick = () => {
  deleteModal.style.display = 'none';
  productToDelete = null;
};

document.getElementById('confirmDeleteBtn').onclick = async () => {
  if (!productToDelete) return;
  const token = localStorage.getItem('jwtToken');
  if (!token) return alert('JWT missing');

  try {
    const res = await fetch(`/admin/api/products/${productToDelete}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();

    if (res.ok) {
      document.querySelector(`tr[data-id="${productToDelete}"]`)?.remove();
      deleteModal.style.display = 'none';
    } else {
      alert(json.error || 'Failed to delete');
    }
  } catch (err) {
    console.error(err);
    alert('Error deleting product');
  } finally {
    productToDelete = null;
  }
};
</script>
{% endblock %}
