{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1.5rem;">Products</h1>

<button id="addProductBtn" style="
    background-color:#4f46e5;
    color:#ffffff;
    font-weight:700;
    padding:0.5rem 1.25rem;
    border:none;
    border-radius:12px;
    cursor:pointer;
    margin-bottom:1rem;
    transition: all 0.2s ease;
">Add Product</button>

<table style="width:100%; border-collapse:collapse; text-align:left; box-shadow:0 4px 10px rgba(0,0,0,0.05); border-radius:8px; overflow:hidden;">
  <thead>
    <tr style="background-color:#f8f9fa;">
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">ID</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Name</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Price</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Stock</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Category</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Image</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for p in products %}
    <tr data-id="{{ p.id }}" style="border-bottom:1px solid #e9ecef; vertical-align:middle;">
      <td style="padding:10px;">{{ p.id }}</td>
      <td style="padding:10px;">{{ p.name }}</td>
      <td style="padding:10px;">${{ "%.2f"|format(p.price) }}</td>
      <td style="padding:10px;">{{ p.stock }}</td>
      <td style="padding:10px;">{{ p.category.name if p.category else 'N/A' }}</td>
      <td style="padding:10px;">
        {% if p.image %}
        <img src="{{ url_for('static', filename='images/' ~ p.image) }}" alt="{{ p.name }}" style="max-width:80px; max-height:80px; object-fit:cover; border-radius:8px; display:block; margin:auto; border:1px solid #e9ecef; padding:2px;">
        {% else %}N/A{% endif %}
      </td>
      <td style="padding:10px;">
        <button class="btn edit-btn" onclick="openEditModal({{ p.id }})" style="margin-right:5px;background:#4f46e5;color:#fff;padding:0.35rem 0.75rem;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;">Edit</button>
        <button class="btn btn-danger" onclick="deleteProduct({{ p.id }})" style="background:#ff4757;color:#fff;padding:0.35rem 0.75rem;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modals (Add & Edit) remain the same as your previous HTML -->
<!-- Edit modal id="editProductModal" etc. -->

{% endblock %}

{% block scripts %}
{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ----------------- Modal Logic -----------------
  const addBtn = document.getElementById("addProductBtn");
  const addModal = document.getElementById("addProductModal");
  const closeAdd = document.getElementById("closeAddModal");
  addBtn.onclick = () => addModal.style.display = "flex";
  closeAdd.onclick = () => addModal.style.display = "none";

  const editModal = document.getElementById("editProductModal");
  const closeEdit = document.getElementById("closeEditModal");
  closeEdit.onclick = () => editModal.style.display = "none";

  // ----------------- Open Edit Modal -----------------
  window.openEditModal = async function(id){
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("JWT missing"); return; }

    try {
      const res = await fetch(`/admin/api/products/${id}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      if(!res.ok){ alert("Failed to fetch product"); return; }
      const data = await res.json();

      document.getElementById("editProductId").value = data.id;
      document.getElementById("editName").value = data.name;
      document.getElementById("editPrice").value = data.price;
      document.getElementById("editStock").value = data.stock;
      document.getElementById("editCategory").value = data.category_id || '';
      editModal.style.display = "flex";

    } catch(err){
      alert("Error fetching product: " + err.message);
    }
  }

  // ----------------- Add Product -----------------
  document.getElementById('productForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const formData = new FormData(e.target);
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("JWT missing"); return; }

    const res = await fetch("/admin/api/products/", {
      method: "POST",
      headers: { "Authorization": "Bearer "+token },
      body: formData
    });
    const data = await res.json();
    document.getElementById("response").innerHTML = res.ok ? '<span style="color:green">Product added!</span>' : `<span style="color:red">${data.error||'Failed'}</span>`;
    if(res.ok) setTimeout(()=>location.reload(),1000);
  });

  // ----------------- Edit Product -----------------
  document.getElementById('editProductForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const formData = new FormData(e.target);
    const id = formData.get('product_id');
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("JWT missing"); return; }

    try{
      const res = await fetch(`/admin/api/products/${id}`, {
        method: "PATCH",
        headers: { "Authorization": "Bearer "+token },
        body: formData
      });
      const data = await res.json();

      document.getElementById("editResponse").innerHTML = res.ok ? '<span style="color:green">Product updated!</span>' : `<span style="color:red">${data.error||'Failed'}</span>`;

      if(res.ok){
        // Update table row instantly
        const row = document.querySelector(`tr[data-id='${id}']`);
        if(row){
          row.children[1].innerText = data.product.name;
          row.children[2].innerText = "$" + parseFloat(data.product.price).toFixed(2);
          row.children[3].innerText = data.product.stock;
          row.children[4].innerText = document.getElementById("editCategory").selectedOptions[0].text;
          if(data.product.image){
            row.children[5].innerHTML = `<img src="/static/images/${data.product.image}" style="max-width:80px;max-height:80px;object-fit:cover;border-radius:8px;display:block;margin:auto;border:1px solid #e9ecef;padding:2px;">`;
          }
        }
        setTimeout(()=>editModal.style.display="none",500);
      }
    } catch(err){
      alert("Error updating product: " + err.message);
    }
  });

  // ----------------- Delete Product -----------------
  window.deleteProduct = async function(id){
    if(!confirm("Are you sure you want to delete this product?")) return;
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("JWT missing"); return; }

    try{
      const res = await fetch(`/admin/api/products/${id}`, {
        method:"DELETE",
        headers:{ "Authorization":"Bearer "+token, "Accept":"application/json" }
      });
      const data = await res.json();
      if(res.ok){
        alert(data.message || "Product deleted!");
        const row = document.querySelector(`tr[data-id='${id}']`);
        if(row) row.remove();
      }else{
        alert(data.error || "Failed to delete product");
      }
    }catch(err){
      alert("Error: "+err.message);
    }
  }

  // ----------------- Close modals on outside click -----------------
  window.onclick = (e)=>{
    if(e.target==addModal) addModal.style.display="none";
    if(e.target==editModal) editModal.style.display="none";
  };

});
</script>
{% endblock %}

{% endblock %}
