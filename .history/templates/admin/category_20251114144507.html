{% extends "admin/base.html" %}

{% block title %}Categories{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1.5rem;">Categories</h1>

<button id="addCategoryBtn" style="
    background:#4f46e5;color:#fff;font-weight:700;
    padding:.5rem 1.25rem;border:none;border-radius:12px;
    cursor:pointer;margin-bottom:1rem;transition:all .2s;">
    Add Category
</button>

<!-- Search Bar -->
<div style="margin-bottom:1rem;">
  <input type="text" id="categorySearch" placeholder="Search categories by name..." 
         style="width:100%;max-width:400px;padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;font-size:0.9rem;">
</div>

<table style="width:100%;border-collapse:collapse;text-align:left;
             box-shadow:0 4px 10px rgba(0,0,0,.05);border-radius:8px;overflow:hidden;">
  <thead>
    <tr style="background:#f8f9fa;">
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">ID</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Name</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Description</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Products</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Actions</th>
    </tr>
  </thead>
  <tbody id="categoryTableBody">
    {% for cat in categories %}
    <tr data-id="{{ cat.id }}" style="border-bottom:1px solid #e9ecef;vertical-align:middle;">
      <td style="padding:10px;">{{ cat.id }}</td>
      <td style="padding:10px;">{{ cat.name }}</td>
      <td style="padding:10px;font-size:0.9rem;color:#555;">
        {{ cat.description|truncate(80) if cat.description else '—' }}
      </td>
      <td style="padding:10px;">
        <span class="badge" style="background:#e0f2fe;color:#0c4a6e;padding:.25rem .5rem;border-radius:6px;font-size:0.85rem;">
          {{ cat.products|length }}
        </span>
      </td>
      <td style="padding:10px;">
        <button class="edit-btn" onclick="openEditModal({{ cat.id }})"
                style="margin-right:5px;background:#4f46e5;color:#fff;
                       padding:.35rem .75rem;border:none;border-radius:8px;
                       cursor:pointer;transition:all .2s;font-size:0.85rem;">Edit</button>
        <button class="delete-btn" 
                onclick="openDeleteModal({{ cat.id }}, {{ cat.name|tojson }})"
                style="background:#ff4757;color:#fff;padding:.35rem .75rem;
                       border:none;border-radius:8px;cursor:pointer;transition:all .2s;font-size:0.85rem;">
          Delete
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ========== ADD CATEGORY MODAL ========== -->
<div id="addCategoryModal" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:999;">
  <div style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:500px;">
    <span id="closeAddModal" style="float:right;font-size:1.5rem;cursor:pointer;color:#6c757d;">×</span>
    <h2 style="margin-top:0;color:#1d1d1f;">Add New Category</h2>
    <form id="addCategoryForm">
      <label style="display:block;margin-bottom:.5rem;font-weight:600;">Name <span style="color:red;">*</span></label>
      <input type="text" name="name" required style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;font-weight:600;">Description</label>
      <textarea name="description" rows="3" style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;resize:vertical;"></textarea>

      <button type="submit" style="background:#4f46e5;color:#fff;padding:.6rem 1.2rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Save Category
      </button>
    </form>
    <div id="addResponse" style="margin-top:1rem;min-height:1.5rem;font-size:0.9rem;"></div>
  </div>
</div>

<!-- ========== EDIT CATEGORY MODAL ========== -->
<div id="editCategoryModal" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:999;">
  <div style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:500px;">
    <span id="closeEditModal" style="float:right;font-size:1.5rem;cursor:pointer;color:#6c757d;">×</span>
    <h2 style="margin-top:0;color:#1d1d1f;">Edit Category</h2>
    <form id="editCategoryForm">
      <input type="hidden" name="category_id" id="editCategoryId">

      <label style="display:block;margin-bottom:.5rem;font-weight:600;">Name <span style="color:red;">*</span></label>
      <input type="text" id="editName" name="name" required style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;font-weight:600;">Description</label>
      <textarea id="editDescription" name="description" rows="3" style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;resize:vertical;"></textarea>

      <button type="submit" style="background:#4f46e5;color:#fff;padding:.6rem 1.2rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Update Category
      </button>
    </form>
  </div>
</div>

<!-- ========== DELETE CONFIRM MODAL ========== -->
<div id="deleteConfirmModal" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:420px;text-align:center;">
    <h3 style="margin:0 0 1rem;font-size:1.25rem;color:#1d1d1f;">Delete Category</h3>
    <p style="margin:0 0 1.5rem;color:#555;font-size:0.95rem;">
      Are you sure you want to delete <strong id="deleteCategoryName"></strong>?<br>
      This will <strong>not delete</strong> products, but they will lose their category.
    </p>
    <div style="display:flex;gap:0.75rem;justify-content:center;">
      <button id="cancelDeleteBtn"
              style="background:#e9ecef;color:#1d1d1f;padding:.6rem 1.2rem;
                     border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Cancel
      </button>
      <button id="confirmDeleteBtn"
              style="background:#ff4757;color:#fff;padding:.6rem 1.2rem;
                     border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Delete
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    loadCategories();
});

// ------------------------------
// LOAD ALL CATEGORIES
// ------------------------------
function loadCategories() {
    fetch("/admin/api/categories", {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
    })
    .then(res => res.json())
    .then(categories => {
        const tbody = document.getElementById("category-table-body");
        tbody.innerHTML = "";

        categories.forEach(cat => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${cat.id}</td>
                <td>${cat.name}</td>
                <td>${cat.description?.substring(0, 80) || ""}</td>
                <td>
                    ${cat.image_url ? `<img src="${cat.image_url}" width="60" height="60" style="object-fit:cover;border-radius:6px;">` : "No Image"}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openEditModal(${cat.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    });
}



// ------------------------------
// CREATE CATEGORY
// ------------------------------
function createCategory() {
    const formData = new FormData(document.getElementById("create-category-form"));

    fetch("/admin/api/categories", {
        method: "POST",
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` },
        body: formData
    })
    .then(res => res.json())
    .then(() => {
        loadCategories();
        document.getElementById("create-category-form").reset();
        alert("Category created!");
    });
}



// ------------------------------
// OPEN EDIT MODAL
// ------------------------------
function openEditModal(id) {
    fetch("/admin/api/categories", {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
    })
    .then(res => res.json())
    .then(categories => {
        const cat = categories.find(c => c.id === id);
        if (!cat) return;

        document.getElementById("edit-category-id").value = cat.id;
        document.getElementById("edit-category-name").value = cat.name;
        document.getElementById("edit-category-description").value = cat.description || "";
        document.getElementById("existing-category-image").src = cat.image_url || "";

        new bootstrap.Modal(document.getElementById("editCategoryModal")).show();
    });
}



// ------------------------------
// UPDATE CATEGORY
// ------------------------------
function updateCategory() {
    const id = document.getElementById("edit-category-id").value;
    const formData = new FormData(document.getElementById("edit-category-form"));

    fetch(`/admin/api/categories/${id}`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` },
        body: formData
    })
    .then(res => res.json())
    .then(() => {
        loadCategories();
        alert("Updated!");
    });
}



// ------------------------------
// DELETE CATEGORY
// ------------------------------
function deleteCategory(id) {
    if (!confirm("Delete this category?")) return;

    fetch(`/admin/api/categories/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
    })
    .then(res => res.json())
    .then(() => {
        loadCategories();
        alert("Category deleted.");
    });
}
</script>

{% endblock %}