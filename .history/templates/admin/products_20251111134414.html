{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<main class="content main-content-wrapper">
    <div class="container main-content">
        <h1>Products</h1>
        <button class="btn" id="addProductBtn" style="margin-bottom:1rem;">Add Product</button>

        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color:#f8f9fa; text-align:left;">
                    <th style="padding:0.5rem; border-bottom:1px solid #e9ecef;">ID</th>
                    <th style="padding:0.5rem; border-bottom:1px solid #e9ecef;">Name</th>
                    <th style="padding:0.5rem; border-bottom:1px solid #e9ecef;">Price</th>
                    <th style="padding:0.5rem; border-bottom:1px solid #e9ecef;">Stock</th>
                    <th style="padding:0.5rem; border-bottom:1px solid #e9ecef;">Category ID</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                <tr>
                    <td style="padding:0.5rem; border-bottom:1px solid #e9ecef;">{{ p.id }}</td>
                    <td style="padding:0.5rem; border-bottom:1px solid #e9ecef;">{{ p.name }}</td>
                    <td style="padding:0.5rem; border-bottom:1px solid #e9ecef;">{{ p.price }}</td>
                    <td style="padding:0.5rem; border-bottom:1px solid #e9ecef;">{{ p.stock }}</td>
                    <td style="padding:0.5rem; border-bottom:1px solid #e9ecef;">{{ p.category_id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Add Product Modal -->
        <div class="modal" id="addProductModal" style="
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.5);
            justify-content:center; align-items:center;
            z-index:1000;
        ">
            <div class="modal-content" style="
                background:#fff; padding:2rem; border-radius:12px; max-width:400px; width:90%;
                position:relative;
            ">
                <span class="close" id="closeModal" style="
                    position:absolute; top:1rem; right:1rem; font-size:1.5rem; cursor:pointer;
                ">&times;</span>
                <h2>Add Product</h2>
                <form id="productForm" enctype="multipart/form-data">
                    <input type="text" name="name" placeholder="Name" required style="width:100%; margin-bottom:0.75rem;"><br>
                    <input type="number" step="0.01" name="price" placeholder="Price" required style="width:100%; margin-bottom:0.75rem;"><br>
                    <input type="number" name="stock" placeholder="Stock" required style="width:100%; margin-bottom:0.75rem;"><br>
                    <input type="number" name="category_id" placeholder="Category ID" required style="width:100%; margin-bottom:0.75rem;"><br>
                    <input type="file" name="image" style="margin-bottom:0.75rem;"><br>
                    <button type="submit" class="btn" style="background:#4f46e5; color:#fff; padding:0.5rem 1rem; border-radius:8px;">Add Product</button>
                </form>
                <div id="response" style="margin-top:0.75rem;"></div>
            </div>
        </div>
    </div>
</main>

<script>
const addBtn = document.getElementById("addProductBtn");
const modal = document.getElementById("addProductModal");
const closeBtn = document.getElementById("closeModal");

addBtn.onclick = () => modal.style.display = "flex";
closeBtn.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

const form = document.getElementById('productForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("You need a JWT token!"); return; }

    const res = await fetch("/api/products/", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
    });

    const data = await res.json();
    const responseDiv = document.getElementById("response");

    if(res.ok){
        responseDiv.innerHTML = `<span style="color:green;">Product added successfully!</span>`;
        form.reset();
        setTimeout(() => location.reload(), 1000);
    } else {
        responseDiv.innerHTML = `<span style="color:red;">Error: ${data.error || 'Failed to add product'}</span>`;
    }
});
</script>
{% endblock %}
