{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<h1>Products</h1>
<button class="btn" id="addProductBtn">Add Product</button>

<table style="margin-top:10px;">
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Category</th>
        <th>Image</th>
    </tr>
    {% for p in products %}
    <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.name }}</td>
        <td>${{ "%.2f"|format(p.price) }}</td>
        <td>{{ p.stock }}</td>
        <td>{{ p.category.name if p.category else p.category_id }}</td>
        <td>
            {% if p.image %}
                <img src="{{ url_for('static', filename='uploads/' ~ p.image) }}" alt="{{ p.name }}" width="50">
            {% else %}
                N/A
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

<!-- Add Product Modal -->
<div class="modal" id="addProductModal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Add Product</h2>
        <form id="productForm" enctype="multipart/form-data">
            <input type="text" name="name" placeholder="Name" required><br><br>
            <input type="number" step="0.01" name="price" placeholder="Price" required><br><br>
            <input type="number" name="stock" placeholder="Stock" required><br><br>
            <select name="category_id" required>
                <option value="">Select Category</option>
                {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select><br><br>
            <input type="file" name="image" accept="image/*"><br><br>
            <button type="submit" class="btn">Add Product</button>
        </form>
        <div id="response" style="margin-top:10px;"></div>
    </div>
</div>

<script>
const addBtn = document.getElementById("addProductBtn");
const modal = document.getElementById("addProductModal");
const closeBtn = document.getElementById("closeModal");

addBtn.onclick = () => modal.style.display = "flex";
closeBtn.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

const form = document.getElementById('productForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("You need a JWT token!"); return; }

    const res = await fetch("/api/products/", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
    });

    const data = await res.json();
    const responseDiv = document.getElementById("response");
    if(data.success){
        responseDiv.innerHTML = `<span style="color:green;">Product added successfully!</span>`;
        form.reset();
        setTimeout(() => location.reload(), 1000); // refresh to show new product
    } else {
        responseDiv.innerHTML = `<span style="color:red;">Error: ${data.error || 'Failed to add product'}</span>`;
    }
});
</script>
{% endblock %}
