{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Dashboard</h1>
<p class="text-muted">Welcome, <span id="adminUsername">Admin</span>. Manage your store and view analytics here.</p>

<div id="dashboardGrid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
    gap:1.5rem;
    margin-top:1rem;
">
  <!-- Stats Cards Loaded via JS -->
</div>

<!-- ---------- FILTERS & CHART ---------- -->
<div style="margin-top:2rem; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05);">
  <h2 style="font-weight:700;color:#1d1d1f;margin-bottom:1rem;">Purchase Reports</h2>

  <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1.5rem;">
    <select id="reportType" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="custom">Custom</option>
    </select>

    <input type="date" id="startDate" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;display:none;">
    <input type="date" id="endDate"   style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;display:none;">

    <input type="text" id="userSearch" placeholder="Search user..." style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
    <select id="usernameFilter" style="padding:.5rem 1rem;border:1px solid #ced4da;border-radius:8px;">
      <option value="">All Users</option>
    </select>
  </div>

  <canvas id="purchaseChart" style="width:100%;max-height:400px;"></canvas>
</div>
{% endblock %}


{% block scripts %}
<!-- Chart.js + time adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<script>
/* ------------------------------------------------------------------ */
/*  Global variables                                                  */
/* ------------------------------------------------------------------ */
let purchaseChart = null;

/* ------------------------------------------------------------------ */
/*  Debounce helper                                                   */
/* ------------------------------------------------------------------ */
function debounce(fn, wait = 300) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

/* ------------------------------------------------------------------ */
/*  Load product / category stats                                     */
/* ------------------------------------------------------------------ */
async function loadCounts() {
  try {
    const opts = { credentials: 'include', headers: { Accept: 'application/json' } };
    const [prodRes, catRes] = await Promise.all([
      fetch('/admin/api/products', opts),
      fetch('/admin/api/categories', opts)
    ]);

    if (!prodRes.ok || !catRes.ok) throw new Error('API error');

    const products   = await prodRes.json();
    const categories = await catRes.json();

    const grid = document.getElementById('dashboardGrid');
    grid.innerHTML = `
      <div class="stat-card">
        <div class="stat-title">Total Products</div>
        <h2 class="stat-value" style="color:#4f46e5;">${products.length}</h2>
        <small class="text-muted">Active items in catalog</small>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Categories</div>
        <h2 class="stat-value" style="color:#16a34a;">${categories.length}</h2>
        <small class="text-muted">Product groupings</small>
      </div>
    `;

    // hover animation
    grid.querySelectorAll('.stat-card').forEach(c => {
      c.addEventListener('mouseenter', () => c.style.transform = 'translateY(-4px)');
      c.addEventListener('mouseleave', () => c.style.transform = '');
    });

  } catch (e) {
    console.error('loadCounts →', e);
  }
}

/* ------------------------------------------------------------------ */
/*  Build the purchase line chart                                     */
/* ------------------------------------------------------------------ */
async function loadPurchaseReport(usernameOverride) {
  try {
    const type   = document.getElementById('reportType').value;
    const start  = document.getElementById('startDate').value;
    const end    = document.getElementById('endDate').value;
    const username = (usernameOverride !== undefined)
                     ? usernameOverride
                     : document.getElementById('usernameFilter').value;

    const params = new URLSearchParams({ type });
    if (username) params.append('username', username);
    if (type === 'custom') {
      if (!start || !end) return;               // wait for both dates
      params.append('start', start);
      params.append('end',   end);
    }

    const url = `/admin/api/reports/purchases?${params.toString()}`;
    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error('Report fetch failed');

    const data = await res.json();   // expected shape: { labels?, totals?, invoices? }

    let labels = [];
    let totals = [];

    // ----------------------------------------------------------------
    // 1. When a specific user is selected → show per-invoice line
    // ----------------------------------------------------------------
    if (username && data.invoices) {
      const userInvoices = data.invoices
        .filter(i => i.username === username)
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

      labels = userInvoices.map(i => i.created_at.split('T')[0]);
      totals = userInvoices.map(i => i.total_amount);
    }
    // ----------------------------------------------------------------
    // 2. Otherwise show aggregated totals (daily/weekly/monthly)
    // ----------------------------------------------------------------
    else {
      labels = data.labels || [];
      totals = data.totals || [];
    }

    const ctx = document.getElementById('purchaseChart').getContext('2d');
    if (purchaseChart) purchaseChart.destroy();

    purchaseChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: username ? `Purchases of ${username}` : 'Total Purchases ($)',
          data: totals,
          backgroundColor: 'rgba(79,70,229,0.2)',
          borderColor: '#4f46e5',
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#4f46e5'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 0 } }
        }
      }
    });

  } catch (e) {
    console.error('loadPurchaseReport →', e);
  }
}

/* ------------------------------------------------------------------ */
/*  Username search → populate dropdown                               */
/* ------------------------------------------------------------------ */
const debouncedUserSearch = debounce(async function () {
  const term = document.getElementById('userSearch').value.trim().toLowerCase();
  const select = document.getElementById('usernameFilter');

  // reset dropdown
  select.innerHTML = '<option value="">All Users</option>';

  if (!term) {
    loadPurchaseReport();               // back to “All Users”
    return;
  }

  try {
    const res = await fetch(
      `/admin/api/reports/usernames?search=${encodeURIComponent(term)}`,
      { credentials: 'include' }
    );
    if (!res.ok) throw new Error('Usernames fetch failed');
    const users = await res.json();

    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      select.appendChild(opt);
    });

    // auto-select if only one result
    if (users.length === 1) {
      select.value = users[0];
      loadPurchaseReport(users[0]);
    } else {
      loadPurchaseReport();           // keep current chart (All Users)
    }

  } catch (e) {
    console.error('userSearch →', e);
  }
}, 350);

/* ------------------------------------------------------------------ */
/*  UI event wiring                                                   */
/* ------------------------------------------------------------------ */
document.getElementById('reportType').addEventListener('change', () => {
  const isCustom = document.getElementById('reportType').value === 'custom';
  document.getElementById('startDate').style.display = isCustom ? 'inline-block' : 'none';
  document.getElementById('endDate').style.display   = isCustom ? 'inline-block' : 'none';
  loadPurchaseReport();
});

document.getElementById('usernameFilter').addEventListener('change', () => loadPurchaseReport());
document.getElementById('startDate').addEventListener('change', () => loadPurchaseReport());
document.getElementById('endDate').addEventListener('change',   () => loadPurchaseReport());

document.getElementById('userSearch').addEventListener('input', debouncedUserSearch);

/* ------------------------------------------------------------------ */
/*  Initial load                                                      */
/* ------------------------------------------------------------------ */
document.getElementById('adminUsername').textContent = 'Admin';
loadCounts();
loadPurchaseReport();          // default: daily, all users
</script>

<style>
.stat-card {
  background:#fff;
  padding:1.5rem;
  border-radius:12px;
  border:1px solid #e9ecef;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
  transition:transform .2s, box-shadow .2s;
}
.stat-card:hover {
  transform:translateY(-4px);
  box-shadow:0 8px 20px rgba(0,0,0,.1);
}
.stat-title { font-weight:700; font-size:1.1rem; color:#1d1d1f; }
.stat-value { margin-top:.5rem; }
</style>
{% endblock %}