{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<h1 style="font-size:2rem;font-weight:700;color:#1d1d1f;margin-bottom:1.5rem;">Products</h1>

<button id="addProductBtn" style="
    background-color:#4f46e5;color:#fff;font-weight:700;
    padding:.5rem 1.25rem;border:none;border-radius:12px;
    cursor:pointer;margin-bottom:1rem;transition:all .2s ease;">
    Add Product
</button>

<table style="width:100%;border-collapse:collapse;text-align:left;
             box-shadow:0 4px 10px rgba(0,0,0,.05);border-radius:8px;overflow:hidden;">
  <thead>
    <tr style="background:#f8f9fa;">
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">ID</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Name</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Price</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Stock</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Category</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Image</th>
      <th style="padding:12px 15px;border-bottom:2px solid #e9ecef;">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for p in products %}
    <tr data-id="{{ p.id }}" style="border-bottom:1px solid #e9ecef;vertical-align:middle;">
      <td style="padding:10px;">{{ p.id }}</td>
      <td style="padding:10px;">{{ p.name }}</td>
      <td style="padding:10px;">${{ "%.2f"|format(p.price) }}</td>
      <td style="padding:10px;">{{ p.stock }}</td>
      <td style="padding:10px;">{{ p.category.name if p.category else 'N/A' }}</td>
      <td style="padding:10px;">
        {% if p.image %}
        <img src="{{ url_for('static', filename='images/' ~ p.image) }}"
             alt="{{ p.name }}"
             style="max-width:80px;max-height:80px;object-fit:cover;
                    border-radius:8px;display:block;margin:auto;
                    border:1px solid #e9ecef;padding:2px;">
        {% else %}N/A{% endif %}
      </td>
      <td style="padding:10px;">
        <button class="edit-btn" onclick="openEditModal({{ p.id }})"
                style="margin-right:5px;background:#4f46e5;color:#fff;
                       padding:.35rem .75rem;border:none;border-radius:8px;
                       cursor:pointer;transition:all .2s;">Edit</button>
        <button class="btn-danger" onclick="deleteProduct({{ p.id }})"
                style="background:#ff4757;color:#fff;
                       padding:.35rem .75rem;border:none;border-radius:8px;
                       cursor:pointer;transition:all .2s;">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{# ======================  ADD PRODUCT MODAL  ====================== #}
<div id="addProductModal" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
  <div class="modal-content"
       style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:500px;">
    <span id="closeAddModal" class="close"
          style="float:right;font-size:1.5rem;cursor:pointer;">&times;</span>
    <h2 style="margin-top:0;">Add New Product</h2>

    <form id="productForm" enctype="multipart/form-data">
      <label style="display:block;margin-bottom:.5rem;">Name</label>
      <input type="text" name="name" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Price</label>
      <input type="number" step="0.01" name="price" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Stock</label>
      <input type="number" name="stock" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Category</label>
      <select name="category_id"
              style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">
        <option value="">-- None --</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>

      <label style="display:block;margin-bottom:.5rem;">Image</label>
      <input type="file" name="image" accept="image/*"
             style="width:100%;padding:.5rem;margin-bottom:1rem;">

      <button type="submit"
              style="background:#4f46e5;color:#fff;padding:.6rem 1.2rem;
                     border:none;border-radius:8px;cursor:pointer;">
        Save Product
      </button>
    </form>
    <div id="response" style="margin-top:1rem;"></div>
  </div>
</div>

{# ======================  EDIT PRODUCT MODAL  ====================== #}
<div id="editProductModal" class="modal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
  <div class="modal-content"
       style="background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:500px;">
    <span id="closeEditModal" class="close"
          style="float:right;font-size:1.5rem;cursor:pointer;">&times;</span>
    <h2 style="margin-top:0;">Edit Product</h2>

    <form id="editProductForm" enctype="multipart/form-data">
      <input type="hidden" name="product_id" id="editProductId">

      <label style="display:block;margin-bottom:.5rem;">Name</label>
      <input type="text" id="editName" name="name" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Price</label>
      <input type="number" step="0.01" id="editPrice" name="price" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Stock</label>
      <input type="number" id="editStock" name="stock" required
             style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">

      <label style="display:block;margin-bottom:.5rem;">Category</label>
      <select id="editCategory" name="category_id"
              style="width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid #ced4da;border-radius:6px;">
        <option value="">-- None --</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>

      <label style="display:block;margin-bottom:.5rem;">Image (leave empty to keep current)</label>
      <input type="file" name="image" accept="image/*"
             style="width:100%;padding:.5rem;margin-bottom:1rem;">

      <button type="submit"
              style="background:#4f46e5;color:#fff;padding:.6rem 1.2rem;
                     border:none;border-radius:8px;cursor:pointer;">
        Update Product
      </button>
    </form>
    <div id="editResponse" style="margin-top:1rem;"></div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
/* ----------  GLOBAL MODAL HELPERS ---------- */
const addModal   = document.getElementById('addProductModal');
const editModal  = document.getElementById('editProductModal');
const closeAdd   = document.getElementById('closeAddModal');
const closeEdit  = document.getElementById('closeEditModal');

document.getElementById('addProductBtn').onclick = () => addModal.style.display = 'flex';
closeAdd.onclick   = () => addModal.style.display = 'none';
closeEdit.onclick  = () => editModal.style.display = 'none';

window.onclick = e => {
  if (e.target === addModal)  addModal.style.display  = 'none';
  if (e.target === editModal) editModal.style.display = 'none';
};

/* ----------  OPEN EDIT MODAL ---------- */
async function openEditModal(id){
  const token = localStorage.getItem('jwtToken');
  if (!token) { alert('JWT missing'); return; }

  try{
    const res = await fetch(`/admin/api/products/${id}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('Failed to fetch product');
    const data = await res.json();

    // fill fields
    document.getElementById('editProductId').value   = data.id;
    document.getElementById('editName').value       = data.name;
    document.getElementById('editPrice').value      = data.price;
    document.getElementById('editStock').value      = data.stock;
    document.getElementById('editCategory').value   = data.category_id || '';

    editModal.style.display = 'flex';
  }catch(err){
    alert(err.message);
  }
}

/* ----------  ADD PRODUCT ---------- */
document.getElementById('productForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const token = localStorage.getItem('jwtToken');
  if (!token) { alert('JWT missing'); return; }

  const res = await fetch('/admin/api/products/', {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` },
    body: formData
  });
  const json = await res.json();

  const respDiv = document.getElementById('response');
  respDiv.innerHTML = res.ok
    ? '<span style="color:green">Product added!</span>'
    : `<span style="color:red">${json.error || 'Failed'}</span>`;

  if (res.ok) setTimeout(() => location.reload(), 1000);
});

/* ----------  EDIT PRODUCT ---------- */
document.getElementById('editProductForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const id = formData.get('product_id');
  const token = localStorage.getItem('jwtToken');
  if (!token) { alert('JWT missing'); return; }

  const res = await fetch(`/admin/api/products/${id}`, {
    method: 'PATCH',
    headers: { Authorization: `Bearer ${token}` },
    body: formData
  });
  const json = await res.json();

  const respDiv = document.getElementById('editResponse');
  respDiv.innerHTML = res.ok
    ? '<span style="color:green">Product updated!</span>'
    : `<span style="color:red">${json.error || 'Failed'}</span>';

  if (res.ok){
    // ---- instantly refresh the row ----
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (row){
      row.children[1].textContent = json.product.name;
      row.children[2].textContent = '$' + Number(json.product.price).toFixed(2);
      row.children[3].textContent = json.product.stock;

      const catSelect = document.getElementById('editCategory');
      const catText   = catSelect.selectedOptions[0]
                         ? catSelect.selectedOptions[0].text
                         : 'N/A';
      row.children[4].textContent = catText;

      if (json.product.image){
        row.children[5].innerHTML = `<img src="/static/images/${json.product.image}"
                 style="max-width:80px;max-height:80px;object-fit:cover;
                        border-radius:8px;display:block;margin:auto;
                        border:1px solid #e9ecef;padding:2px;">`;
      }
    }
    setTimeout(() => editModal.style.display = 'none', 600);
  }
});

/* ----------  DELETE PRODUCT ---------- */
async function deleteProduct(id){
  if (!confirm('Are you sure you want to delete this product?')) return;
  const token = localStorage.getItem('jwtToken');
  if (!token) { alert('JWT missing'); return; }

  try{
    const res = await fetch(`/admin/api/products/${id}`, {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: 'application/json'
      }
    });
    const json = await res.json();
    
    if (res.ok){
      alert(json.message || 'Product deleted!');
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (row) row.remove();
    } else {
      alert(json.error || 'Failed to delete product');
    }
  }catch(err){
    alert('Error: ' + err.message);
  }
}
</script>
{% endblock %}