{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<main class="content main-content-wrapper">
    <div class="container main-content">
        <h1 style="font-size:2rem; font-weight:700; color:#1d1d1f; margin-bottom:1.5rem;">Products</h1>
        <button id="addProductBtn" style="
            background-color: #4f46e5;
            color: #ffffff;
            font-weight:700;
            padding: 0.5rem 1.25rem;
            border:none;
            border-radius:12px;
            cursor:pointer;
            transition: all 0.2s ease;
            margin-bottom:1rem;
        ">Add Product</button>

<table style="margin-top:10px; width:100%; border-collapse: collapse; text-align:left;">
    <thead>
        <tr style="background-color:#f8f9fa;">
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">ID</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Name</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Price</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Stock</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Category</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Image</th>
            <th style="padding:10px; border-bottom:2px solid #e9ecef;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for p in products %}
        <tr style="border-bottom:1px solid #e9ecef; vertical-align:middle;">
            <td style="padding:10px;">{{ p.id }}</td>
            <td style="padding:10px;">{{ p.name }}</td>
            <td style="padding:10px;">${{ "%.2f"|format(p.price) }}</td>
            <td style="padding:10px;">{{ p.stock }}</td>
            <td style="padding:10px;">{{ p.category.name if p.category else 'N/A' }}</td>
            <td style="padding:10px;">
                {% if p.image %}
                    <img src="{{ url_for('static', filename='images/' ~ p.image) }}" 
                         alt="{{ p.name }}" 
                         style="max-width:80px; max-height:80px; object-fit:cover; border-radius:8px; display:block; margin:auto;">
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td style="padding:10px;">
                <button class="btn" onclick="openEditModal({{ p.id }}, '{{ p.name }}', {{ p.price }}, {{ p.stock }}, {{ p.category.id if p.category else 'null' }})">Edit</button>
                <button class="btn btn-danger" onclick="deleteProduct({{ p.id }})">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Edit Product Modal -->
<div class="modal" id="editProductModal">
    <div class="modal-content">
        <span class="close" id="closeEditModal">&times;</span>
        <h2>Edit Product</h2>
        <form id="editProductForm" enctype="multipart/form-data">
            <input type="hidden" name="product_id" id="editProductId">
            <input type="text" name="name" id="editName" placeholder="Name" required><br><br>
            <input type="number" step="0.01" name="price" id="editPrice" placeholder="Price" required><br><br>
            <input type="number" name="stock" id="editStock" placeholder="Stock" required><br><br>
            <select name="category_id" id="editCategory" required>
                <option value="">Select Category</option>
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select><br><br>
            <input type="file" name="image"><br><br>
            <button type="submit" class="btn">Save Changes</button>
        </form>
        <div id="editResponse"></div>
    </div>
</div>



        <!-- Add Product Modal -->
        <div class="modal" id="addProductModal" style="
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            justify-content:center;
            align-items:center;
            z-index:1000;
        ">
            <div class="modal-content" style="
                background: #ffffff;
                border-radius: 12px;
                padding: 2rem;
                max-width: 450px;
                width:90%;
                position:relative;
                box-shadow:0 10px 30px rgba(0,0,0,0.1);
            ">
                <span class="close" id="closeModal" style="
                    position:absolute;
                    top:1rem;
                    right:1rem;
                    font-size:1.5rem;
                    cursor:pointer;
                    color:#4f46e5;
                ">&times;</span>
                <h2 style="font-size:1.5rem; font-weight:700; color:#1d1d1f; margin-bottom:1rem;">Add Product</h2>
                <form id="productForm" enctype="multipart/form-data">
                    <input type="text" name="name" placeholder="Name" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <input type="number" step="0.01" name="price" placeholder="Price" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <input type="number" name="stock" placeholder="Stock" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <select name="category_id" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">
                        <option value="" disabled selected>Select Category</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>

                    <input type="file" name="image" style="margin-bottom:0.75rem;">

                    <button type="submit" class="btn" style="
                        background-color:#4f46e5;
                        color:#fff;
                        font-weight:700;
                        padding:0.5rem 1.25rem;
                        border:none;
                        border-radius:12px;
                        cursor:pointer;
                        transition: all 0.2s ease;
                    ">Add Product</button>
                </form>
                <div id="response" style="margin-top:0.75rem;"></div>
            </div>
        </div>
    </div>
</main>

<script>
const addBtn = document.getElementById("addProductBtn");
const modal = document.getElementById("addProductModal");
const closeBtn = document.getElementById("closeModal");

addBtn.onclick = () => modal.style.display = "flex";
closeBtn.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

const form = document.getElementById('productForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("You need a JWT token!"); return; }

    const res = await fetch("/api/products/", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
    });

    const data = await res.json();
    const responseDiv = document.getElementById("response");

    if(res.ok){
        responseDiv.innerHTML = `<span style="color:green;">Product added successfully!</span>`;
        form.reset();
        setTimeout(() => location.reload(), 1000);
    } else {
        responseDiv.innerHTML = `<span style="color:red;">Error: ${data.error || 'Failed to add product'}</span>`;
    }
});
</script>
{% endblock %}
