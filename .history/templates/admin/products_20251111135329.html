{% extends "admin/base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<main class="content main-content-wrapper">
    <div class="container main-content">
        <h1 style="font-size:2rem; font-weight:700; color:#1d1d1f; margin-bottom:1.5rem;">Products</h1>
        <button id="addProductBtn" style="
            background-color: #4f46e5;
            color: #ffffff;
            font-weight:700;
            padding: 0.5rem 1.25rem;
            border:none;
            border-radius:12px;
            cursor:pointer;
            transition: all 0.2s ease;
            margin-bottom:1rem;
        ">Add Product</button>

        <table style="margin-top:10px; width:100%; border-collapse: collapse;">
            <tr style="background-color:#f8f9fa;">
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Category</th>
                <th>Image</th>
            </tr>
            {% for p in products %}
            <tr style="border-bottom:1px solid #e9ecef;">
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>${{ "%.2f"|format(p.price) }}</td>
                <td>{{ p.stock }}</td>
                <td>{{ p.category.name if p.category else 'N/A' }}</td>
                <td>
                    {% if p.image %}
                        <img src="{{ url_for('static', filename='images/' ~ p.image) }}" 
                            alt="{{ p.name }}" 
                            style="max-width:80px; max-height:80px; object-fit:cover; border-radius:8px;">
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>


        <!-- Add Product Modal -->
        <div class="modal" id="addProductModal" style="
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            justify-content:center;
            align-items:center;
            z-index:1000;
        ">
            <div class="modal-content" style="
                background: #ffffff;
                border-radius: 12px;
                padding: 2rem;
                max-width: 450px;
                width:90%;
                position:relative;
                box-shadow:0 10px 30px rgba(0,0,0,0.1);
            ">
                <span class="close" id="closeModal" style="
                    position:absolute;
                    top:1rem;
                    right:1rem;
                    font-size:1.5rem;
                    cursor:pointer;
                    color:#4f46e5;
                ">&times;</span>
                <h2 style="font-size:1.5rem; font-weight:700; color:#1d1d1f; margin-bottom:1rem;">Add Product</h2>
                <form id="productForm" enctype="multipart/form-data">
                    <input type="text" name="name" placeholder="Name" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <input type="number" step="0.01" name="price" placeholder="Price" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <input type="number" name="stock" placeholder="Stock" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">

                    <select name="category_id" required style="
                        width:100%;
                        padding:0.5rem 0.75rem;
                        border:1px solid #e9ecef;
                        border-radius:8px;
                        margin-bottom:0.75rem;
                    ">
                        <option value="" disabled selected>Select Category</option>
                        {% for c in categories %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>

                    <input type="file" name="image" style="margin-bottom:0.75rem;">

                    <button type="submit" class="btn" style="
                        background-color:#4f46e5;
                        color:#fff;
                        font-weight:700;
                        padding:0.5rem 1.25rem;
                        border:none;
                        border-radius:12px;
                        cursor:pointer;
                        transition: all 0.2s ease;
                    ">Add Product</button>
                </form>
                <div id="response" style="margin-top:0.75rem;"></div>
            </div>
        </div>
    </div>
</main>

<script>
const addBtn = document.getElementById("addProductBtn");
const modal = document.getElementById("addProductModal");
const closeBtn = document.getElementById("closeModal");

addBtn.onclick = () => modal.style.display = "flex";
closeBtn.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

const form = document.getElementById('productForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const token = localStorage.getItem("jwtToken");
    if(!token){ alert("You need a JWT token!"); return; }

    const res = await fetch("/api/products/", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
    });

    const data = await res.json();
    const responseDiv = document.getElementById("response");

    if(res.ok){
        responseDiv.innerHTML = `<span style="color:green;">Product added successfully!</span>`;
        form.reset();
        setTimeout(() => location.reload(), 1000);
    } else {
        responseDiv.innerHTML = `<span style="color:red;">Error: ${data.error || 'Failed to add product'}</span>`;
    }
});
</script>
{% endblock %}
