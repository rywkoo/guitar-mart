{% extends "base.html" %}
{% block title %}Shopping Cart - Mini Mart{% endblock %}

{% block content %}
<div style="max-width:1200px; margin:2rem auto; padding:0 1rem;">

  <h1 style="font-size:2rem; font-weight:700; margin-bottom:2rem; text-align:center;">Your Cart</h1>

  <div id="cartContainer" style="display:flex; flex-wrap:wrap; gap:2rem;">
    <!-- Cart Items -->
    <div id="cartItems" style="flex: 2; min-width:300px;"></div>

    <!-- Cart Summary -->
    <div id="cartSummary" style="flex:1; min-width:280px; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); height:max-content; display:none;">
      <h2 style="font-size:1.25rem; font-weight:700; margin-bottom:1.5rem;">Order Summary</h2>
      <div id="summaryLines"></div>
      <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.1rem; margin:1rem 0 2rem;">
        <span>Total</span>
        <span id="totalPrice">$0.00</span>
      </div>
      <button id="checkoutBtn" style="width:100%; background:#4f46e5; color:white; border:none; padding:0.75rem; font-size:1rem; font-weight:700; border-radius:12px; cursor:pointer; transition:all 0.2s;">
        Proceed to Checkout
      </button>
    </div>
  </div>

  <div id="emptyCart" style="text-align:center; padding:3rem; color:#888; display:none;">
    <p>Your cart is empty. <a href="/shop" style="color:var(--color-primary);">Continue shopping</a></p>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function getCart() {
  return JSON.parse(localStorage.getItem('cart') || '[]');
}

function saveCart(cart) {
  localStorage.setItem('cart', JSON.stringify(cart));
  window.updateCartCount();
  renderCart();
}

function removeFromCart(productId) {
  let cart = getCart();
  cart = cart.filter(item => item.id !== productId);
  saveCart(cart);
}

function updateQuantity(productId, newQty) {
  if (newQty < 1) return;
  let cart = getCart();
  const item = cart.find(i => i.id === productId);
  if (item) {
    item.quantity = newQty;
    saveCart(cart);
  }
}

function renderCart() {
  const cart = getCart();
  const itemsContainer = document.getElementById('cartItems');
  const summaryContainer = document.getElementById('cartSummary');
  const emptyMsg = document.getElementById('emptyCart');

  if (cart.length === 0) {
    itemsContainer.innerHTML = '';
    summaryContainer.style.display = 'none';
    emptyMsg.style.display = 'block';
    return;
  }

  emptyMsg.style.display = 'none';
  summaryContainer.style.display = 'block';

  itemsContainer.innerHTML = '';
  let subtotal = 0;

  cart.forEach(item => {
    const itemTotal = item.price * item.quantity;
    subtotal += itemTotal;

    const imgSrc = item.image ? `/static/images/${item.image}` : 'https://via.placeholder.com/120?text=No+Image';

    const div = document.createElement('div');
    div.style.cssText = 'display:flex; gap:1rem; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:1.5rem; align-items:center;';
    div.innerHTML = `
      <img src="${imgSrc}" alt="${item.name}" style="width:120px; height:120px; object-fit:cover; border-radius:12px;">
      <div style="flex:1;">
        <h3 style="margin:0 0 0.5rem; font-size:1.1rem; font-weight:600;">${item.name}</h3>
        <p style="margin:0; color:#555;">Category: ${item.category_name || 'None'}</p>
        <p style="margin:0.5rem 0 0; font-weight:600;">$${item.price.toFixed(2)}</p>
        <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
          <label style="font-size:0.9rem; color:#555;">Qty:</label>
          <input type="number" value="${item.quantity}" min="1" data-id="${item.id}"
                 style="width:60px; padding:0.3rem; border:1px solid #ced4da; border-radius:6px;">
        </div>
      </div>
      <button onclick="removeFromCart(${item.id})" 
              style="background:#ff4757; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:600;">
        Remove
      </button>
    `;
    itemsContainer.appendChild(div);
  });

  // Summary
  const tax = subtotal * 0.05;
  const total = subtotal + tax;

  document.getElementById('summaryLines').innerHTML = `
    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
      <span>Subtotal</span>
      <span>$${subtotal.toFixed(2)}</span>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
      <span>Tax (5%)</span>
      <span>$${tax.toFixed(2)}</span>
    </div>
  `;
  document.getElementById('totalPrice').textContent = `$${total.toFixed(2)}`;
}

// Event delegation for quantity
document.getElementById('cartItems').addEventListener('change', e => {
  if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
    const id = parseInt(e.target.dataset.id);
    const qty = parseInt(e.target.value);
    updateQuantity(id, qty);
  }
});

document.getElementById('checkoutBtn')?.addEventListener('click', () => {
  alert('Checkout functionality not implemented yet.');
});

// Init
document.addEventListener('DOMContentLoaded', () => {
  renderCart();
  window.updateCartCount();
});
</script>
{% endblock %}