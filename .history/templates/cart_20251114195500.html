{% extends "base.html" %}
{% block title %}Shopping Cart - Mini Mart{% endblock %}

{% block content %}
<div style="max-width:1200px; margin:2rem auto; padding:0 1rem;">

  <h1 style="font-size:2rem; font-weight:700; margin-bottom:2rem; text-align:center;">Your Cart</h1>

  <div id="cartContainer" style="display:flex; flex-wrap:wrap; gap:2rem;">
    <!-- Cart Items -->
    <div id="cartItems" style="flex: 2; min-width:300px;"></div>

    <!-- Cart Summary -->
    <div id="cartSummary" style="flex:1; min-width:280px; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); height:max-content; display:none;">
      <h2 style="font-size:1.25rem; font-weight:700; margin-bottom:1.5rem;">Order Summary</h2>
      <div id="summaryLines"></div>
      <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.1rem; margin:1rem 0 2rem;">
        <span>Total</span>
        <span id="totalPrice">$0.00</span>
      </div>
<button onclick="removeFromCart(${it.id})"
        style="background:#ff4757;color:white;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600;">
  Remove
</button>
    </div>
  </div>

  <div id="emptyCart" style="text-align:center; padding:3rem; color:#888; display:none;">
    <p>Your cart is empty. <a href="/shop" style="color:var(--color-primary);">Continue shopping</a></p>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- CART HELPERS ---------- */
function getCart() { return JSON.parse(localStorage.getItem('cart') || '[]'); }
function saveCart(c) { localStorage.setItem('cart', JSON.stringify(c)); updateCartCount(); renderCart(); }

function addToCart(p) {
  const cart = getCart();
  const ex = cart.find(i => i.id === p.id);
  if (ex) ex.quantity += 1; else cart.push({...p, quantity:1});
  saveCart(cart);
}
function removeFromCart(id) {
  if (!confirm('Remove this item from the cart?')) return;
  const cart = getCart().filter(i => i.id !== id);
  saveCart(cart);
}
function changeQty(id, qty) {
  if (qty < 1) return;
  const cart = getCart();
  const it = cart.find(i => i.id === id);
  if (it) { it.quantity = qty; saveCart(cart); }
}

/* ---------- UPDATE NAVBAR BADGE ---------- */
function updateCartCount() {
  const total = getCart().reduce((s,i)=>s+i.quantity,0);
  document.querySelectorAll('.cart-link').forEach(l=>{
    let badge = l.querySelector('.cart-count');
    if (!badge) {
      badge = document.createElement('sup'); badge.className='cart-count';
      Object.assign(badge.style,{
        marginLeft:'4px', background:'var(--color-primary)', color:'white',
        borderRadius:'50%', fontSize:'0.7rem', padding:'2px 6px',
        minWidth:'18px', textAlign:'center'
      });
      l.appendChild(badge);
    }
    badge.textContent = total||'';
    badge.style.display = total?'inline':'none';
  });
}

/* ---------- RENDER CART ---------- */
function renderCart() {
  const cart = getCart();
  const itemsDiv = document.getElementById('cartItems');
  const sumDiv   = document.getElementById('cartSummary');
  const emptyDiv = document.getElementById('emptyCart');

  // ---- empty ----
  if (!cart.length) {
    itemsDiv.innerHTML = '';
    sumDiv.style.display = 'none';
    emptyDiv.style.display = 'block';
    return;
  }
  emptyDiv.style.display = 'none';
  sumDiv.style.display = 'block';

  itemsDiv.innerHTML = '';
  let subtotal = 0;

  cart.forEach(it => {
    const line = it.price * it.quantity;
    subtotal += line;
    const img = it.image ? `/static/images/${it.image}` : 'https://via.placeholder.com/120?text=No+Image';

    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:1rem;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:1.5rem;align-items:center;';
    row.innerHTML = `
      <img src="${img}" alt="${it.name}" style="width:120px;height:120px;object-fit:cover;border-radius:12px;">
      <div style="flex:1;">
        <h3 style="margin:0 0 .5rem;font-size:1.1rem;font-weight:600;">${it.name}</h3>
        <p style="margin:0;color:#555;">Category: ${it.category_name||'—'}</p>
        <p style="margin:.5rem 0 0;font-weight:600;">$${it.price.toFixed(2)}</p>
        <div style="margin-top:.5rem;display:flex;gap:.5rem;align-items:center;">
          <label style="font-size:.9rem;color:#555;">Qty:</label>
          <input type="number" value="${it.quantity}" min="1" data-id="${it.id}"
                 style="width:60px;padding:.3rem;border:1px solid #ced4da;border-radius:6px;">
        </div>
      </div>
      <button onclick="removeFromCart(${it.id})"
              style="background:#ff4757;color:white;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600;">
        Remove
      </button>
    `;
    itemsDiv.appendChild(row);
  });

  const tax   = subtotal * 0.05;
  const total = subtotal + tax;

  document.getElementById('summaryLines').innerHTML = `
    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
      <span>Subtotal</span><span>$${subtotal.toFixed(2)}</span>
    </div>
    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;">
      <span>Tax (5%)</span><span>$${tax.toFixed(2)}</span>
    </div>
  `;
  document.getElementById('totalPrice').textContent = `$${total.toFixed(2)}`;
}

/* ---------- EVENT DELEGATION ---------- */
document.getElementById('cartItems').addEventListener('change', e => {
  if (e.target.matches('input[type=number]')) {
    const id  = Number(e.target.dataset.id);
    const qty = Number(e.target.value);
    changeQty(id, qty);
  }
});

/* ---------- CHECKOUT BUTTON ---------- */
document.getElementById('checkoutBtn')?.addEventListener('click', () => {
  alert('Checkout not implemented – you would POST the cart to /checkout here.');
});

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded', () => {
  renderCart();
  updateCartCount();          // also called from shop page
});
</script>
{% endblock %}