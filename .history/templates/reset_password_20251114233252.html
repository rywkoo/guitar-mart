{% extends "base.html" %}
{% block title %}Reset Password - Mini Mart{% endblock %}

{% block content %}
<style>
  body {
    font-family: "DM Sans", sans-serif;
    background-color: #f9fafb;
    color: #1d1d1f;
  }

  /* Main Container */
  .reset-container {
    max-width: 400px;
    margin: 5rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    text-align: center;
  }

  .reset-container h2 {
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #1d1d1f;
  }

  /* Inputs */
  input {
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 1rem;
    transition: border 0.2s;
  }

  input:focus {
    outline: none;
    border-color: #4f46e5;
  }

  /* Buttons */
  button {
    background-color: #4f46e5;
    color: #fff;
    border: none;
    padding: 0.75rem;
    border-radius: 50px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    font-size: 1rem;
    transition: all 0.2s;
    margin-top: 0.5rem;
  }

  button:hover {
    background-color: #4338ca;
    transform: translateY(-1px);
  }

  button:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* Messages */
  .msg {
    margin-top: 1rem;
    font-size: 0.95rem;
    min-height: 1.5rem;
  }

  .msg.success { color: #16a34a; }
  .msg.error { color: #dc2626; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }

  .modal-content h3 {
    margin-bottom: 1rem;
    color: #1d1d1f;
    font-weight: 700;
  }

  .modal-content input {
    margin-bottom: 1rem;
  }

  .modal-content button {
    margin-top: 0.5rem;
  }

  .back-link {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: #5f5f65;
  }

  .back-link a {
    color: #4f46e5;
    font-weight: 700;
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .reset-container, .modal-content {
      margin: 2rem auto;
      padding: 1.5rem;
    }
  }
</style>

<div class="reset-container">
  <h2>Reset Your Password</h2>
  <form id="resetForm">
    <input type="email" id="email" placeholder="Enter your email" required autocomplete="email">
    <button type="submit" id="requestBtn">Request Reset Token</button>
    <div id="msg" class="msg"></div>
  </form>

  <div class="back-link">
    Remembered your password? <a href="/login">Login here</a>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content" id="modalContent">
    <h3>Enter the token sent to your email</h3>
    <p style="color:#5f5f65;font-size:0.9rem;margin-bottom:1rem;">
      Check your inbox (and spam) for the 6-digit code
    </p>
    <input type="text" id="token" placeholder="000000" maxlength="6" required autocomplete="off">
    <button id="verifyToken">Verify Token</button>
    <div id="modalMsg" class="msg"></div>
  </div>
</div>

<script>
  const resetForm = document.getElementById("resetForm");
  const modal = document.getElementById("modal");
  const modalContent = document.getElementById("modalContent");
  const modalMsg = document.getElementById("modalMsg");
  const msg = document.getElementById("msg");
  const requestBtn = document.getElementById("requestBtn");

  let emailGlobal = "";
  let tokenGlobal = "";

  // Helper: Set message
  function setMsg(el, text, type = "error") {
    el.textContent = text;
    el.className = `msg ${type}`;
  }

  // Helper: Disable button
  function disableBtn(btn, disabled = true) {
    btn.disabled = disabled;
    btn.style.opacity = disabled ? "0.6" : "1";
  }

  // Open modal
  function openModal() {
    modal.style.display = "flex";
    setTimeout(() => document.getElementById("token")?.focus(), 100);
  }

  // Close modal
  function closeModal() {
    modal.style.display = "none";
    setMsg(modalMsg, "");
    document.getElementById("token") && (document.getElementById("token").value = "");
  }

  // Step 1: Request token
  resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    if (!email) return setMsg(msg, "Please enter your email.");

    emailGlobal = email;
    disableBtn(requestBtn);
    setMsg(msg, "Sending token...", "");

    try {
      const res = await fetch("/api/reset/request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();

      if (res.ok) {
        setMsg(msg, "Token sent! Check your email.", "success");
        openModal();
      } else {
        setMsg(msg, data.error || data.message || "Failed to send token.");
      }
    } catch {
      setMsg(msg, "Network error. Please try again.");
    } finally {
      disableBtn(requestBtn, false);
    }
  });

  // Step 2: Verify token
  async function verifyToken() {
    const token = document.getElementById("token").value.trim();
    if (!token || token.length !== 6) return setMsg(modalMsg, "Enter 6-digit code.");

    tokenGlobal = token;
    setMsg(modalMsg, "Verifying...", "");
    disableBtn(document.getElementById("verifyToken"));

    try {
      const res = await fetch("/api/reset/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailGlobal, token })
      });
      const data = await res.json();

      if (res.ok) {
        showNewPasswordForm();
      } else {
        setMsg(modalMsg, data.error || "Invalid or expired token.");
      }
    } catch {
      setMsg(modalMsg, "Network error.");
    } finally {
      disableBtn(document.getElementById("verifyToken"), false);
    }
  }

  // Step 3: Show new password form
  function showNewPasswordForm() {
    modalContent.innerHTML = `
      <h3>Set New Password</h3>
      <p style="color:#5f5f65;font-size:0.9rem;margin-bottom:1rem;">
        Choose a strong password
      </p>
      <input type="password" id="newPassword" placeholder="New Password" required autocomplete="new-password">
      <input type="password" id="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password">
      <button id="submitNewPassword">Reset Password</button>
      <div id="modalMsg" class="msg"></div>
    `;

    document.getElementById("submitNewPassword").addEventListener("click", resetPassword);
    setTimeout(() => document.getElementById("newPassword").focus(), 100);
  }

  // Step 4: Reset password
  async function resetPassword() {
    const newPassword = document.getElementById("newPassword").value.trim();
    const confirmPassword = document.getElementById("confirmPassword").value.trim();
    const modalMsgInner = document.getElementById("modalMsg");

    if (!newPassword || !confirmPassword) {
      return setMsg(modalMsgInner, "Please fill both fields.");
    }
    if (newPassword !== confirmPassword) {
      return setMsg(modalMsgInner, "Passwords do not match.");
    }
    if (newPassword.length < 6) {
      return setMsg(modalMsgInner, "Password must be at least 6 characters.");
    }

    disableBtn(document.getElementById("submitNewPassword"));
    setMsg(modalMsgInner, "Updating password...", "");

    try {
      const res = await fetch("/api/reset/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailGlobal, token: tokenGlobal, new_password: newPassword })
      });
      const data = await res.json();

      if (res.ok) {
        setMsg(modalMsgInner, data.message || "Password reset successfully!", "success");
        setTimeout(() => {
          closeModal();
          window.location.href = "/login";
        }, 1800);
      } else {
        setMsg(modalMsgInner, data.error || data.message || "Failed to reset password.");
      }
    } catch {
      setMsg(modalMsgInner, "Network error.");
    } finally {
      disableBtn(document.getElementById("submitNewPassword"), false);
    }
  }

  // Event Listeners
  document.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // Enter key in token input
  document.getElementById("modal").addEventListener("keypress", (e) => {
    if (e.key === "Enter" && document.getElementById("token")) {
      verifyToken();
    }
  });

  // Auto-format token input
  document.addEventListener("input", (e) => {
    if (e.target.id === "token") {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    }
  });
</script>
{% endblock %}