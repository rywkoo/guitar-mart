{% extends "base.html" %}
{% block title %}Reset Password - Mini Mart{% endblock %}
{% block content %}
<style>
    :root {
        --color-background: #ffffff;
        --color-text-primary: #1d1d1f;
        --color-link-secondary: #5f5f65;
        --color-cta: #ff4757;
        --color-cta-text: #ffffff;
        --color-cta-shadow: rgba(255, 71, 87, 0.4);
        --font-family-sans-serif: "DM Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --font-weight-bold: 700;
        --navbar-height: 80px;
        --navbar-padding: 1.5rem;
        --transition-speed: 0.2s;
    }

    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap');

    body {
        font-family: var(--font-family-sans-serif);
        color: var(--color-text-primary);
        background-color: var(--color-background);
    }

    .reset-container {
        max-width: 500px;
        margin: 5rem auto;
        background: #fff;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    }

    .reset-container h2 {
        font-weight: var(--font-weight-bold);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    label {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    input {
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }

    input:focus {
        border-color: var(--color-cta);
        outline: none;
    }

    button {
        background-color: var(--color-cta);
        color: var(--color-cta-text);
        border: none;
        padding: 0.75rem;
        border-radius: 50px;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px var(--color-cta-shadow);
    }

    .msg {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.95rem;
    }

    .msg.success {
        color: #16a34a;
    }

    .msg.error {
        color: #dc2626;
    }

    /* --- Token box --- */
    .token-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
        border: 1px solid #ddd;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-family: monospace;
        margin-top: 0.5rem;
    }

    .token-text {
        word-break: break-all;
    }

    .copy-btn {
        background-color: var(--color-cta);
        color: var(--color-cta-text);
        border: none;
        padding: 0.3rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.2s ease;
    }

    .copy-btn:hover {
        background-color: #e63b4c;
    }
</style>

<div class="reset-container">
    <h2>Reset Your Password</h2>

    <!-- Step 1: Request Reset Token -->
    <form id="requestForm">
        <label for="email">Enter your account email</label>
        <input type="email" id="email" placeholder="user@example.com" required>
        <button type="submit">Request Reset Token</button>
        <div id="requestMsg" class="msg"></div>
        <div id="tokenBox" style="display:none;" class="token-box">
            <span id="tokenText" class="token-text"></span>
            <button type="button" id="copyTokenBtn" class="copy-btn">Copy Token</button>
        </div>
    </form>

    <hr style="margin: 2rem 0; border: none; border-top: 1px solid #eee;">

    <!-- Step 2: Confirm Reset -->
    <form id="confirmForm">
        <label for="token">Reset Token</label>
        <input type="text" id="token" placeholder="Paste your reset token here" required>

        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password" required>

        <button type="submit">Reset Password</button>
        <div id="confirmMsg" class="msg"></div>
    </form>
</div>

<script>
document.getElementById("requestForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const msgBox = document.getElementById("requestMsg");
    const tokenBox = document.getElementById("tokenBox");
    const tokenText = document.getElementById("tokenText");

    msgBox.textContent = "Sending...";
    msgBox.className = "msg";

    try {
        const res = await fetch("/api/reset/request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
        });
        const data = await res.json();

        if (res.ok) {
            tokenText.textContent = data.reset_token;
            tokenBox.style.display = "flex";
            msgBox.textContent = "Your reset token is ready!";
            msgBox.className = "msg success";
        } else {
            msgBox.textContent = data.msg || "Error requesting reset.";
            msgBox.className = "msg error";
            tokenBox.style.display = "none";
        }
    } catch (err) {
        msgBox.textContent = "Network error.";
        msgBox.className = "msg error";
        tokenBox.style.display = "none";
    }
});

document.getElementById("copyTokenBtn").addEventListener("click", () => {
    const tokenText = document.getElementById("tokenText").textContent;
    navigator.clipboard.writeText(tokenText);
    alert("Token copied!");
});

document.getElementById("confirmForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const token = document.getElementById("token").value;
    const password = document.getElementById("newPassword").value;
    const msgBox = document.getElementById("confirmMsg");

    msgBox.textContent = "Submitting...";
    msgBox.className = "msg";

    try {
        const res = await fetch("/api/reset/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, password }),
        });

        const data = await res.json();

        if (res.ok) {
            msgBox.textContent = data.msg;
            msgBox.className = "msg success";
        } else {
            msgBox.textContent = data.msg || "Error resetting password.";
            msgBox.className = "msg error";
        }
    } catch (err) {
        msgBox.textContent = "Network error.";
        msgBox.className = "msg error";
    }
});
</script>
{% endblock %}
