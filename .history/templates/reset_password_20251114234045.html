{% extends "base.html" %}
{% block title %}Reset Password - Mini Mart{% endblock %}

{% block content %}
<style>
  body {font-family:"DM Sans",sans-serif;background:#f9fafb;color:#1d1d1f;}
  .reset-container{max-width:400px;margin:5rem auto;padding:2rem;background:#fff;border-radius:16px;
    box-shadow:0 8px 24px rgba(0,0,0,.05);text-align:center;}
  .reset-container h2{font-weight:700;margin-bottom:1.5rem;color:#1d1d1f;}
  input{width:100%;padding:.75rem;margin-bottom:1rem;border-radius:8px;border:1px solid #ddd;
    font-size:1rem;transition:border .2s;}
  input:focus{outline:none;border-color:#4f46e5;}
  button{background:#4f46e5;color:#fff;border:none;padding:.75rem;border-radius:50px;
    font-weight:700;cursor:pointer;width:100%;font-size:1rem;transition:all .2s;margin-top:.5rem;}
  button:hover{background:#4338ca;transform:translateY(-1px);}
  button:disabled{background:#9ca3af;cursor:not-allowed;transform:none;}
  .msg{margin-top:1rem;font-size:.95rem;min-height:1.5rem;}
  .msg.success{color:#16a34a;}.msg.error{color:#dc2626;}
  .modal{display:none;position:fixed;z-index:999;inset:0;background:rgba(0,0,0,.5);
    justify-content:center;align-items:center;}
  .modal-content{background:#fff;padding:2rem;border-radius:16px;width:90%;max-width:400px;
    text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.1);}
  .modal-content h3{margin-bottom:1rem;color:#1d1d1f;font-weight:700;}
  .modal-content input{margin-bottom:1rem;}
  .back-link{margin-top:1.5rem;font-size:.9rem;color:#5f5f65;}
  .back-link a{color:#4f46e5;font-weight:700;text-decoration:none;}
  .back-link a:hover{text-decoration:underline;}
  @media(max-width:480px){.reset-container,.modal-content{margin:2rem auto;padding:1.5rem;}}
</style>

<div class="reset-container">
  <h2>Reset Your Password</h2>
  <form id="resetForm">
    <input type="email" id="email" placeholder="Enter your email" required autocomplete="email">
    <button type="submit" id="requestBtn">Request Password Change</button>
    <div id="msg" class="msg"></div>
  </form>

  <div class="back-link">
    Remembered your password? <a href="/login">Login here</a>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content" id="modalContent">
    <h3>Enter the Verification Code sent to your email</h3>
    <p style="color:#5f5f65;font-size:.9rem;margin-bottom:1rem;">
      Check your inbox (and spam) for the 6-digit code
    </p>
    <input type="text" id="token" placeholder="000000" maxlength="6" required autocomplete="off">
    <button id="verifyToken">Verify Code</button>
    <div id="modalMsg" class="msg"></div>
  </div>
</div>

<script>
  const resetForm   = document.getElementById('resetForm');
  const modal       = document.getElementById('modal');
  const modalContent= document.getElementById('modalContent');
  const modalMsg    = document.getElementById('modalMsg');
  const msg         = document.getElementById('msg');
  const requestBtn  = document.getElementById('requestBtn');

  let emailGlobal = '';
  let tokenGlobal = '';

  // ---------- helpers ----------
  const setMsg = (el, txt, type='error') => {
    el.textContent = txt;
    el.className = `msg ${type}`;
  };
  const disableBtn = (btn, yes=true) => {
    btn.disabled = yes;
    btn.style.opacity = yes ? '0.6' : '1';
  };
  const openModal = () => {
    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('token')?.focus(), 100);
  };
  const closeModal = () => {
    modal.style.display = 'none';
    setMsg(modalMsg, '');
    const tok = document.getElementById('token');
    if (tok) tok.value = '';
  };

  // ---------- Step 1: request token ----------
  resetForm.addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    if (!email) return setMsg(msg, 'Please enter your email.');

    emailGlobal = email;
    disableBtn(requestBtn);
    setMsg(msg, 'Sending token...', '');

    try {
      const res = await fetch('/api/reset/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();

      if (res.ok) {
        setMsg(msg, 'Token sent! Check your email.', 'success');
        openModal();
      } else {
        setMsg(msg, data.error || data.message || 'Failed to send token.');
      }
    } catch {
      setMsg(msg, 'Network error. Please try again.');
    } finally {
      disableBtn(requestBtn, false);
    }
  });

  // ---------- Step 2: verify token ----------
  const verifyToken = async () => {
    const token = document.getElementById('token').value.trim();
    if (!token || token.length !== 6) return setMsg(modalMsg, 'Enter 6-digit code.');

    tokenGlobal = token;
    setMsg(modalMsg, 'Verifying...', '');
    disableBtn(document.getElementById('verifyToken'));

    try {
      const res = await fetch('/api/reset/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailGlobal, token })
      });
      const data = await res.json();

      if (res.ok) showNewPasswordForm();
      else setMsg(modalMsg, data.error || 'Invalid or expired token.');
    } catch {
      setMsg(modalMsg, 'Network error.');
    } finally {
      disableBtn(document.getElementById('verifyToken'), false);
    }
  };

  // ---------- Step 3: new password form ----------
  const showNewPasswordForm = () => {
    // Preserve the original modalMsg element
    const originalMsg = modalMsg.cloneNode(true);
    modalContent.innerHTML = `
      <h3>Set New Password</h3>
      <p style="color:#5f5f65;font-size:.9rem;margin-bottom:1rem;">
        Choose a strong password
      </p>
      <input type="password" id="newPassword" placeholder="New Password" required autocomplete="new-password">
      <input type="password" id="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password">
      <button id="submitNewPassword">Reset Password</button>
    `;
    // Re-insert the message div at the end
    modalContent.appendChild(originalMsg);

    document.getElementById('submitNewPassword').addEventListener('click', resetPassword);
    setTimeout(() => document.getElementById('newPassword').focus(), 100);
  };

  // ---------- Step 4: reset password ----------
  const resetPassword = async () => {
    const newPwd = document.getElementById('newPassword').value.trim();
    const confirmPwd = document.getElementById('confirmPassword').value.trim();
    const curMsg = document.getElementById('modalMsg');

    if (!newPwd || !confirmPwd) return setMsg(curMsg, 'Please fill both fields.');
    if (newPwd !== confirmPwd) return setMsg(curMsg, 'Passwords do not match.');
    if (newPwd.length < 6) return setMsg(curMsg, 'Password must be at least 6 characters.');

    disableBtn(document.getElementById('submitNewPassword'));
    setMsg(curMsg, 'Updating password...', '');

    try {
      const res = await fetch('/api/reset/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailGlobal, token: tokenGlobal, new_password: newPwd })
      });
      const data = await res.json();

      if (res.ok) {
        setMsg(curMsg, data.message || 'Password reset successfully!', 'success');
        setTimeout(() => { closeModal(); window.location.href = '/login'; }, 1800);
      } else {
        setMsg(curMsg, data.error || data.message || 'Failed to reset password.');
      }
    } catch {
      setMsg(curMsg, 'Network error.');
    } finally {
      disableBtn(document.getElementById('submitNewPassword'), false);
    }
  };

  // ---------- event wiring ----------
  document.addEventListener('click', e => { if (e.target === modal) closeModal(); });

  // press Enter in token field â†’ verify
  modal.addEventListener('keypress', e => {
    if (e.key === 'Enter' && document.getElementById('token')) verifyToken();
  });

  // keep token numeric & max 6 digits
  document.addEventListener('input', e => {
    if (e.target.id === 'token') e.target.value = e.target.value.replace(/\D/g,'').slice(0,6);
  });

  // attach verify button only once (first load)
  document.getElementById('verifyToken').addEventListener('click', verifyToken);
</script>
{% endblock %}